<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>„ÇØ„ÉÉ„ÇØÂÖàÁîü„ÅÆ‰πù‰πù„Éà„É¨„Éº„Éã„É≥„Ç∞„Ç≤„Éº„É†</title>
  <style>
    :root{
      --bg:#07121f;
      --card: rgba(255,255,255,.10);
      --card2: rgba(255,255,255,.06);
      --line: rgba(255,255,255,.14);
      --text:#f2f6ff;
      --muted:#c6d0f6;
      --accent:#22c55e;
      --accent2:#60a5fa;
      --accent3:#f59e0b;
      --danger:#ef4444;
      --shadow: 0 14px 36px rgba(0,0,0,.40);
      --r: 22px;
    }
    *{ box-sizing:border-box; }
    html, body { height: 100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Sans", "Noto Sans JP", sans-serif;
      color:var(--text);
      background:
        radial-gradient(1100px 700px at 20% 10%, rgba(96,165,250,.22), transparent 55%),
        radial-gradient(900px 650px at 80% 30%, rgba(34,197,94,.18), transparent 55%),
        radial-gradient(900px 650px at 45% 95%, rgba(245,158,11,.14), transparent 55%),
        var(--bg);
      overflow:hidden;
    }
    .app{
      height: 100%;
      max-width: 900px;
      margin: 0 auto;
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      user-select:none;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }
    .logo{
      width:42px;height:42px;border-radius:16px;
      background: linear-gradient(135deg, rgba(96,165,250,.95), rgba(34,197,94,.85));
      box-shadow: var(--shadow);
      flex: 0 0 auto;
      position:relative;
      overflow:hidden;
    }
    .logo::after{
      content:"";
      position:absolute; inset:-55%;
      background: linear-gradient(120deg, transparent, rgba(255,255,255,.22), transparent);
      transform: rotate(20deg);
      animation: shine 6s linear infinite;
    }
    @keyframes shine{
      0%{transform: translateX(-50%) rotate(20deg)}
      100%{transform: translateX(160%) rotate(20deg)}
    }
    .brandText{ display:flex; flex-direction:column; line-height:1.05; min-width:0; }
    .brandText b{
      font-size: 16px;
      font-weight: 1000;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brandText span{
      font-size: 12px;
      color: rgba(255,255,255,.75);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .btn{
      appearance:none;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.10);
      color: var(--text);
      border-radius: 16px;
      padding: 10px 12px;
      font-weight: 1000;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(0,0,0,.22);
      user-select:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.ghost{ background: rgba(255,255,255,.06); }
    .btn.big{
      border-radius: 18px;
      padding: 12px 14px;
      font-size: 16px;
    }
    .btn.primary{
      background: linear-gradient(135deg, rgba(34,197,94,.40), rgba(96,165,250,.24));
      border-color: rgba(34,197,94,.45);
    }
    .btn.disabled, .btn:disabled{
      opacity:.45;
      cursor: not-allowed;
      filter: grayscale(0.3);
    }
    .icon{
      width: 22px; height: 22px;
      display:inline-flex; align-items:center; justify-content:center;
      border-radius: 10px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.16);
      font-size: 14px;
      line-height: 1;
    }

    .card{
      background: var(--card2);
      border: 1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding: 14px;
    }

    .main{
      flex: 1;
      min-height: 0;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    /* mascot */
    .mascotCard{
      padding: 12px 14px;
      background: rgba(255,255,255,.09);
    }
    .mascot{
      display:flex;
      gap: 12px;
      align-items:center;
    }
    .face{
      width:64px;height:64px;border-radius:22px;
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.22), transparent 40%),
        linear-gradient(135deg, rgba(245,158,11,.70), rgba(96,165,250,.55));
      display:flex;align-items:center;justify-content:center;
      font-size: 36px;
      box-shadow: 0 12px 26px rgba(0,0,0,.28);
      flex: 0 0 auto;
    }
    .bubble{
      flex: 1;
      background: rgba(2, 6, 23, .55);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 18px;
      padding: 10px 12px;
      min-height: 56px;
      line-height: 1.35;
    }
    .bubble b{ color: #a7f3d0; }

    /* screens */
    .screen{
      flex: 1;
      min-height: 0;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      text-align:center;
      gap: 10px;
    }
    .hidden{ display:none !important; }

    /* start screen */
    .panel{
      width: min(760px, 100%);
      text-align:left;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }
    .panel h2{
      margin:0;
      font-size: 18px;
      font-weight: 1000;
      letter-spacing: .2px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .panel h2 .tag{
      font-size: 12px;
      font-weight: 1000;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(34,197,94,.16);
      border: 1px solid rgba(34,197,94,.25);
      color: rgba(255,255,255,.88);
    }
    .courseRow{
      display:flex;
      flex-direction:column;
      gap: 10px;
      padding: 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.07);
    }
    .courseRow.locked{
      opacity:.55;
      filter: grayscale(0.25);
    }
    .courseTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight: 1000;
    }
    .courseTitle small{
      font-weight: 900;
      color: rgba(255,255,255,.75);
    }
    .choicesGrid{
      display:grid;
      grid-template-columns: repeat(6, minmax(0,1fr));
      gap: 8px;
    }
    .choicesGridRand{
      display:grid;
      grid-template-columns: repeat(5, minmax(0,1fr));
      gap: 8px;
    }
    .choiceBtn{
      width:100%;
      min-width:0;
      padding: 10px 0;
      border-radius: 14px;
      font-size: 15px;
    }
    .choiceBtn.on{
      outline: 2px solid rgba(96,165,250,.50);
      border-color: rgba(96,165,250,.50);
      background: rgba(96,165,250,.14);
    }
    .toggleRow{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .toggleStar{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .toggleStar .starBtn{
      width: 54px;
      padding: 10px 0;
    }
    .toggleStar .label{
      font-size: 13px;
      font-weight: 1000;
      color: rgba(255,255,255,.85);
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(245,158,11,.18);
      border: 1px solid rgba(245,158,11,.24);
    }

    /* quiz screen */
    .qMath{
      font-size: clamp(46px, 7vw, 74px);
      font-weight: 1100;
      letter-spacing: .4px;
      text-shadow: 0 8px 20px rgba(0,0,0,.35);
    }
    .qYomi{
      font-size: clamp(18px, 3.7vw, 30px);
      font-weight: 1000;
      color: #93c5fd;
    }
    .segmeter{
      width: min(620px, 100%);
      display:flex;
      gap: 8px;
      align-items:center;
      justify-content:center;
      margin-top: 4px;
    }
    .seg{
      flex: 1 1 0;
      height: 16px;
      border-radius: 12px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.16);
      overflow:hidden;
      position:relative;
    }
    .seg.on::before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, rgba(34,197,94,.95), rgba(96,165,250,.95));
    }

    .controlBar{
      width:min(720px, 100%);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-top: 8px;
      flex-wrap:wrap;
    }
    .scoreBits{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap:wrap;
    }
    .bit{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.14);
      font-weight: 1000;
    }
    .bit .badge{
      width: 26px; height: 26px;
      border-radius: 12px;
      display:inline-flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.16);
      font-size: 16px;
      line-height: 1;
    }
    .bit.good .badge{ background: rgba(34,197,94,.18); border-color: rgba(34,197,94,.25); }
    .bit.bad .badge{ background: rgba(239,68,68,.18); border-color: rgba(239,68,68,.25); }
    .bit.q .badge{ background: rgba(96,165,250,.18); border-color: rgba(96,165,250,.25); }

    .flashGood{ animation: flashGood .28s ease; }
    .flashBad{ animation: flashBad .28s ease; }
    @keyframes flashGood{
      0%{ box-shadow: var(--shadow); border-color: rgba(34,197,94,.25); }
      45%{ box-shadow: 0 0 0 4px rgba(34,197,94,.18), var(--shadow); border-color: rgba(34,197,94,.60); }
      100%{ box-shadow: var(--shadow); border-color: rgba(255,255,255,.14); }
    }
    @keyframes flashBad{
      0%{ box-shadow: var(--shadow); border-color: rgba(239,68,68,.25); }
      45%{ box-shadow: 0 0 0 4px rgba(239,68,68,.18), var(--shadow); border-color: rgba(239,68,68,.60); }
      100%{ box-shadow: var(--shadow); border-color: rgba(255,255,255,.14); }
    }

    /* result */
    .resultTitle{
      font-size: clamp(34px, 5vw, 52px);
      font-weight: 1100;
    }
    .resultLine{
      font-size: 18px;
      font-weight: 1000;
      color: rgba(255,255,255,.88);
    }

    @media (max-height: 720px){
      .mascotCard{ padding: 10px 12px; }
      .face{ width:58px; height:58px; border-radius:20px; font-size: 34px; }
      .panel{ gap: 10px; }
      .courseRow{ padding: 10px; gap: 8px; }
      .choiceBtn{ padding: 9px 0; }
    }
  </style>
</head>

<body data-mode="start">
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="brandText">
          <b>„ÇØ„ÉÉ„ÇØÂÖàÁîü„ÅÆ‰πù‰πù„Éà„É¨„Éº„Éã„É≥„Ç∞</b>
          <span>„Åå„Åè„Åó„ÇÖ„ÅÜ„Åò„ÇÉ„Å™„ÅÑ„ÄÇ„Ç≤„Éº„É†„Å†„ÄÇ</span>
        </div>
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button class="btn ghost" id="soundBtn" title="„Åä„Å®„ÉÜ„Çπ„Éà"><span class="icon">‚ô™</span></button>
        <button class="btn ghost" id="resetBtn" title="„É™„Çª„ÉÉ„Éà"><span class="icon">‚Ü∫</span></button>
      </div>
    </header>

    <div class="main">
      <div class="card mascotCard">
        <div class="mascot">
          <div class="face" id="face" aria-hidden="true">ü§ñ</div>
          <div class="bubble">
            <div id="bubbleMain"><b>„Ç≤„Éº„É†„Çí„Åà„Çâ„Çì„Åß„Å≠ÔºÅ</b></div>
            <div id="bubbleSub" style="margin-top:6px; color: rgba(255,255,255,.75); font-weight:900;">Ôºà„Éû„Ç§„ÇØ„ÅÆ „Åç„Çá„Åã„Åå „Å≤„Å§„Çà„ÅÜ„Å†„ÇàÔºâ</div>
          </div>
        </div>
      </div>

      <div class="card" id="mainCard">
        <!-- START -->
        <div class="screen" id="screenStart">
          <div class="panel">
            <h2>„Ç≤„Éº„É†„Åõ„Çì„Åü„Åè <span class="tag" id="lockTag">„Åà„Çâ„Å∂„Å® „É≠„ÉÉ„ÇØ</span></h2>

            <div class="courseRow" id="rowAsc">
              <div class="courseTitle">
                <div>„ÅÆ„Åº„Çä‰πù‰πù</div>
                <small>1‚Üí9</small>
              </div>
              <div class="choicesGrid" id="ascChoices"></div>
              <div class="toggleRow">
                <div class="toggleStar">
                  <button class="btn choiceBtn starBtn" id="ascStar">‚òÖ</button>
                  <div class="label">„Å∞„Çâ„Å∞„Çâ</div>
                </div>
                <button class="btn big primary" id="beginBtnAsc"><span class="icon">‚ñ∂</span> „ÅØ„Åò„ÇÅ„Çã</button>
              </div>
            </div>

            <div class="courseRow" id="rowDesc">
              <div class="courseTitle">
                <div>„Åè„Å†„Çä‰πù‰πù</div>
                <small>9‚Üí1</small>
              </div>
              <div class="choicesGrid" id="descChoices"></div>
              <div class="toggleRow">
                <div class="toggleStar">
                  <button class="btn choiceBtn starBtn" id="descStar">‚òÖ</button>
                  <div class="label">„Å∞„Çâ„Å∞„Çâ</div>
                </div>
                <button class="btn big primary" id="beginBtnDesc"><span class="icon">‚ñ∂</span> „ÅØ„Åò„ÇÅ„Çã</button>
              </div>
            </div>

            <div class="courseRow" id="rowRand">
              <div class="courseTitle">
                <div>„Å∞„Çâ„Å∞„Çâ‰πù‰πù</div>
                <small>„É©„É≥„ÉÄ„É†</small>
              </div>
              <div class="choicesGridRand" id="randChoices"></div>
              <div class="toggleRow" style="justify-content:flex-end;">
                <button class="btn big primary" id="beginBtnRand"><span class="icon">‚ñ∂</span> „ÅØ„Åò„ÇÅ„Çã</button>
              </div>
            </div>
          </div>
        </div>

        <!-- QUIZ -->
        <div class="screen hidden" id="screenQuiz">
          <div class="qMath" id="qMath">2 √ó 1</div>
          <div class="qYomi" id="qYomi">„Å´„ÅÑ„Å°„Åå</div>

          <div class="segmeter" aria-label="countdown">
            <div class="seg on" id="seg1"></div>
            <div class="seg on" id="seg2"></div>
            <div class="seg on" id="seg3"></div>
            <div class="seg on" id="seg4"></div>
            <div class="seg on" id="seg5"></div>
          </div>

          <div class="controlBar">
            <div class="scoreBits">
              <div class="bit q"><span class="badge">üéÆ</span><span id="bitQ">0/0</span></div>
              <div class="bit good"><span class="badge">‚≠ï</span><span id="bitGood">0</span></div>
              <div class="bit bad"><span class="badge">‚ùå</span><span id="bitBad">0</span></div>
            </div>

            <button class="btn big primary" id="playStopBtn" aria-label="start/stop">
              <span class="icon" id="playStopIcon">‚ñ∂</span>
            </button>
          </div>

          <div class="hidden" id="fallbackQuiz" style="width:min(720px,100%); margin-top:6px;">
            <div style="display:grid; grid-template-columns: repeat(5, minmax(0,1fr)); gap:8px;" id="kbdQuiz"></div>
          </div>
        </div>

        <!-- RESULT -->
        <div class="screen hidden" id="screenResult">
          <div class="resultTitle">„ÇØ„É™„Ç¢ÔºÅ</div>
          <div class="resultLine" id="resultLine">‚≠ï 0 / 0</div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:10px;">
            <button class="btn big primary" id="againBtn"><span class="icon">‚ñ∂</span> „ÇÇ„ÅÜ„ÅÑ„Å°„Å©</button>
            <button class="btn big" id="backBtn"><span class="icon">‚Ü©</span> „Åà„Çâ„Å≥„Å™„Åä„Åô</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);

  // UI
  const face = $("face");
  const bubbleMain = $("bubbleMain");
  const bubbleSub  = $("bubbleSub");

  const soundBtn = $("soundBtn");
  const resetBtn = $("resetBtn");

  const screenStart = $("screenStart");
  const screenQuiz  = $("screenQuiz");
  const screenResult= $("screenResult");

  const rowAsc  = $("rowAsc");
  const rowDesc = $("rowDesc");
  const rowRand = $("rowRand");

  const ascChoices = $("ascChoices");
  const descChoices = $("descChoices");
  const randChoices = $("randChoices");

  const ascStar = $("ascStar");
  const descStar = $("descStar");

  const beginBtnAsc  = $("beginBtnAsc");
  const beginBtnDesc = $("beginBtnDesc");
  const beginBtnRand = $("beginBtnRand");

  const qMath = $("qMath");
  const qYomi = $("qYomi");
  const segEls = [$("seg1"),$("seg2"),$("seg3"),$("seg4"),$("seg5")];

  const bitQ = $("bitQ");
  const bitGood = $("bitGood");
  const bitBad = $("bitBad");

  const playStopBtn = $("playStopBtn");
  const playStopIcon = $("playStopIcon");

  const fallbackQuiz = $("fallbackQuiz");
  const kbdQuiz = $("kbdQuiz");

  const resultLine = $("resultLine");
  const againBtn = $("againBtn");
  const backBtn = $("backBtn");

  // Mascot
  const FACES = ["ü§ñ","ü¶ä","üê∏","üêº","ü¶â","üêô","üß†","üöÄ"];
  function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
  function setMascot(emoji, main, sub){
    face.textContent = emoji;
    bubbleMain.innerHTML = main;
    bubbleSub.textContent = sub || "";
  }

  function setScreen(which){
    document.body.setAttribute("data-mode", which);
    screenStart.classList.toggle("hidden", which !== "start");
    screenQuiz.classList.toggle("hidden", which !== "quiz");
    screenResult.classList.toggle("hidden", which !== "result");
  }

  // ---------- Data (‰πù‰πùË™≠„Åø) ----------
  const KUKU = {
    1:{1:{chant:"„ÅÑ„Çì„ÅÑ„Å°„Åå",ans:1},2:{chant:"„ÅÑ„Çì„Å´„Åå",ans:2},3:{chant:"„ÅÑ„Çì„Åï„Çì„Åå",ans:3},4:{chant:"„ÅÑ„Çì„Åó„Åå",ans:4},5:{chant:"„ÅÑ„Çì„Åî„Åå",ans:5},6:{chant:"„ÅÑ„Çì„Çç„Åè„Åå",ans:6},7:{chant:"„ÅÑ„Çì„Åó„Å°„Åå",ans:7},8:{chant:"„ÅÑ„Çì„ÅØ„Å°„Åå",ans:8},9:{chant:"„ÅÑ„Çì„Åè„Åå",ans:9}},
    2:{1:{chant:"„Å´„ÅÑ„Å°„Åå",ans:2},2:{chant:"„Å´„Å´„Çì„Åå",ans:4},3:{chant:"„Å´„Åï„Çì„Åå",ans:6},4:{chant:"„Å´„Åó„Åå",ans:8},5:{chant:"„Å´„Åî",ans:10},6:{chant:"„Å´„Çç„Åè",ans:12},7:{chant:"„Å´„Åó„Å°",ans:14},8:{chant:"„Å´„ÅØ„Å°",ans:16},9:{chant:"„Å´„Åè",ans:18}},
    3:{1:{chant:"„Åï„Çì„ÅÑ„Å°„Åå",ans:3},2:{chant:"„Åï„Çì„Å´„Åå",ans:6},3:{chant:"„Åï„Åñ„Çì„Åå",ans:9},4:{chant:"„Åï„Çì„Åó",ans:12},5:{chant:"„Åï„Çì„Åî",ans:15},6:{chant:"„Åï„Å∂„Çç„Åè",ans:18},7:{chant:"„Åï„Çì„Åó„Å°",ans:21},8:{chant:"„Åï„Çì„Å±",ans:24},9:{chant:"„Åï„Çì„Åè",ans:27}},
    4:{1:{chant:"„Åó„ÅÑ„Å°„Åå",ans:4},2:{chant:"„Åó„Å´„Åå",ans:8},3:{chant:"„Åó„Åï„Çì",ans:12},4:{chant:"„Åó„Åó",ans:16},5:{chant:"„Åó„Åî",ans:20},6:{chant:"„Åó„Çç„Åè",ans:24},7:{chant:"„Åó„Åó„Å°",ans:28},8:{chant:"„Åó„ÅØ",ans:32},9:{chant:"„Åó„Åè",ans:36}},
    5:{1:{chant:"„Åî„ÅÑ„Å°„Åå",ans:5},2:{chant:"„Åî„Å´",ans:10},3:{chant:"„Åî„Åï„Çì",ans:15},4:{chant:"„Åî„Åó",ans:20},5:{chant:"„Åî„Åî",ans:25},6:{chant:"„Åî„Çç„Åè",ans:30},7:{chant:"„Åî„Åó„Å°",ans:35},8:{chant:"„Åî„ÅØ",ans:40},9:{chant:"„Åî„Å£„Åè",ans:45}},
    6:{1:{chant:"„Çç„Åè„ÅÑ„Å°„Åå",ans:6},2:{chant:"„Çç„Åè„Å´",ans:12},3:{chant:"„Çç„Åè„Åï„Çì",ans:18},4:{chant:"„Çç„Åè„Åó",ans:24},5:{chant:"„Çç„Åè„Åî",ans:30},6:{chant:"„Çç„Åè„Çç„Åè",ans:36},7:{chant:"„Çç„Åè„Åó„Å°",ans:42},8:{chant:"„Çç„Åè„ÅØ",ans:48},9:{chant:"„Çç„Å£„Åè",ans:54}},
    7:{1:{chant:"„Åó„Å°„ÅÑ„Å°„Åå",ans:7},2:{chant:"„Åó„Å°„Å´",ans:14},3:{chant:"„Åó„Å°„Åï„Çì",ans:21},4:{chant:"„Åó„Å°„Åó",ans:28},5:{chant:"„Åó„Å°„Åî",ans:35},6:{chant:"„Åó„Å°„Çç„Åè",ans:42},7:{chant:"„Åó„Å°„Åó„Å°",ans:49},8:{chant:"„Åó„Å°„ÅØ",ans:56},9:{chant:"„Åó„Å°„Åè",ans:63}},
    8:{1:{chant:"„ÅØ„Å°„ÅÑ„Å°„Åå",ans:8},2:{chant:"„ÅØ„Å°„Å´",ans:16},3:{chant:"„ÅØ„Å°„Åï„Çì",ans:24},4:{chant:"„ÅØ„Å°„Åó",ans:32},5:{chant:"„ÅØ„Å°„Åî",ans:40},6:{chant:"„ÅØ„Å°„Çç„Åè",ans:48},7:{chant:"„ÅØ„Å°„Åó„Å°",ans:56},8:{chant:"„ÅØ„Å£„Å±",ans:64},9:{chant:"„ÅØ„Å£„Åè",ans:72}},
    9:{1:{chant:"„Åè„ÅÑ„Å°„Åå",ans:9},2:{chant:"„Åè„Å´",ans:18},3:{chant:"„Åè„Åï„Çì",ans:27},4:{chant:"„Åè„Åó",ans:36},5:{chant:"„Åè„Åî",ans:45},6:{chant:"„Åè„Çç„Åè",ans:54},7:{chant:"„Åè„Åó„Å°",ans:63},8:{chant:"„Åè„ÅØ",ans:72},9:{chant:"„Åè„Åè",ans:81}}
  };

  // ---------- Audio: TTS ----------
  function speak(text, {rate=1.20, pitch=1.05, volume=1.0} = {}){
    if (!("speechSynthesis" in window) || !("SpeechSynthesisUtterance" in window)) return false;
    try{
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "ja-JP";
      u.rate = rate;
      u.pitch = pitch;
      u.volume = volume;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
      return true;
    }catch{
      return false;
    }
  }

  // ---------- Audio: SFX (WebAudio) ----------
  let audioCtx = null;
  function ensureAudioCtx(){
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === "suspended") audioCtx.resume().catch(()=>{});
    return audioCtx;
  }
  function playTone(freq, duration, {volume=0.12, type="sine", attack=0.008, release=0.03} = {}){
    if (!(window.AudioContext || window.webkitAudioContext)) return;
    try{
      const ctx = ensureAudioCtx();
      const now = ctx.currentTime;
      const g = ctx.createGain();
      g.gain.setValueAtTime(0.0001, now);
      g.gain.linearRampToValueAtTime(volume, now + attack);
      g.gain.setTargetAtTime(0.0001, now + duration, release);
      g.connect(ctx.destination);

      const o = ctx.createOscillator();
      o.type = type;
      o.frequency.setValueAtTime(freq, now);
      o.connect(g);
      o.start(now);
      o.stop(now + duration + 0.08);
    }catch{}
  }
  function playTick(){ playTone(1100, 0.05, {volume:0.04, type:"square", attack:0.002, release:0.02}); }
  function playCorrect(){
    try{
      const ctx = ensureAudioCtx();
      const now = ctx.currentTime;
      const g = ctx.createGain();
      g.gain.setValueAtTime(0.0001, now);
      g.gain.linearRampToValueAtTime(0.14, now + 0.01);
      g.gain.setTargetAtTime(0.0001, now + 0.55, 0.06);
      g.connect(ctx.destination);
      const o = ctx.createOscillator();
      o.type = "sine";
      o.connect(g);
      o.frequency.setValueAtTime(880, now);
      o.frequency.setValueAtTime(988, now + 0.12);
      o.frequency.setValueAtTime(784, now + 0.24);
      o.frequency.setValueAtTime(1046, now + 0.34);
      o.start(now);
      o.stop(now + 0.70);
    }catch{}
  }
  function playWrong(){
    try{
      const ctx = ensureAudioCtx();
      const now = ctx.currentTime;
      const g = ctx.createGain();
      g.gain.setValueAtTime(0.0001, now);
      g.gain.linearRampToValueAtTime(0.13, now + 0.01);
      g.gain.setTargetAtTime(0.0001, now + 0.42, 0.08);
      g.connect(ctx.destination);
      const o = ctx.createOscillator();
      o.type = "sawtooth";
      o.frequency.setValueAtTime(180, now);
      o.frequency.linearRampToValueAtTime(140, now + 0.12);
      o.frequency.setValueAtTime(160, now + 0.20);
      o.frequency.linearRampToValueAtTime(150, now + 0.42);
      o.connect(g);
      o.start(now);
      o.stop(now + 0.55);
    }catch{}
  }
  function playCheerAndClap(){
    try{
      const ctx = ensureAudioCtx();
      const now = ctx.currentTime;

      const g1 = ctx.createGain();
      g1.gain.setValueAtTime(0.0001, now);
      g1.gain.linearRampToValueAtTime(0.18, now + 0.04);
      g1.gain.setTargetAtTime(0.0001, now + 1.2, 0.20);
      g1.connect(ctx.destination);

      const o1 = ctx.createOscillator();
      o1.type = "triangle";
      o1.connect(g1);
      o1.frequency.setValueAtTime(320, now);
      o1.frequency.exponentialRampToValueAtTime(880, now + 1.0);
      o1.start(now);
      o1.stop(now + 1.4);

      const dur = 1.6;
      const sr = ctx.sampleRate;
      const buf = ctx.createBuffer(1, Math.floor(sr*dur), sr);
      const data = buf.getChannelData(0);
      for (let i=0;i<data.length;i++){
        data[i] = (Math.random()*2-1) * 0.55;
      }
      const src = ctx.createBufferSource();
      src.buffer = buf;

      const bp = ctx.createBiquadFilter();
      bp.type = "bandpass";
      bp.frequency.value = 1400;
      bp.Q.value = 0.7;

      const g2 = ctx.createGain();
      g2.gain.setValueAtTime(0.0001, now);
      g2.gain.linearRampToValueAtTime(0.14, now + 0.06);
      g2.gain.setTargetAtTime(0.0001, now + dur, 0.12);

      src.connect(bp);
      bp.connect(g2);
      g2.connect(ctx.destination);

      const pulseCount = 10;
      for (let p=0;p<pulseCount;p++){
        const t = now + 0.15 + p*0.14 + Math.random()*0.03;
        const v = 0.06 + Math.random()*0.06;
        g2.gain.setValueAtTime(v, t);
        g2.gain.setValueAtTime(0.0001, t + 0.03 + Math.random()*0.02);
      }

      src.start(now);
      src.stop(now + dur);
    }catch{}
  }

  // ---------- SpeechRecognition ----------
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  let rec = null;
  const recognitionOK = !!SpeechRecognition;

  function setupRecognition(){
    if (!recognitionOK) return;
    rec = new SpeechRecognition();
    rec.lang = "ja-JP";
    rec.interimResults = false;
    rec.maxAlternatives = 3;
    rec.continuous = false;

    rec.onresult = (ev) => {
      if (!running || paused || lockedNext) return;
      const res = ev.results?.[0];
      if (!res) return;
      const transcript = String(res[0].transcript || "").trim();
      handleAnswer(transcript);
    };
  }
  function stopRecognition(){ try{ rec && rec.stop(); }catch{} }
  function startRecognition(){ if (!recognitionOK) return; try{ rec.start(); }catch{} }

  // ---------- Answer parsing ----------
  const DIGIT_MAP = {"„Åú„Çç":0,"„Çå„ÅÑ":0,"0":0,"„Äá":0,"Èõ∂":0,"„ÅÑ„Å°":1,"1":1,"‰∏Ä":1,"„Å´":2,"2":2,"‰∫å":2,"„Åï„Çì":3,"3":3,"‰∏â":3,"„Åó":4,"„Çà„Çì":4,"4":4,"Âõõ":4,"„Åî":5,"5":5,"‰∫î":5,"„Çç„Åè":6,"6":6,"ÂÖ≠":6,"„Å™„Å™":7,"„Åó„Å°":7,"7":7,"‰∏É":7,"„ÅØ„Å°":8,"8":8,"ÂÖ´":8,"„Åç„ÇÖ„ÅÜ":9,"„Åè":9,"9":9,"‰πù":9};
  function normalizeKana(s){ return String(s||"").toLowerCase().replace(/\s+/g,"").replace(/„Éº/g,"").replace(/[Ôºå,„ÄÇÔºé.ÔºÅ!Ôºü?]/g,""); }
  function parseNumberJapanese(input){
    const raw = normalizeKana(input);
    if (!raw) return null;
    const m = raw.match(/(\d{1,3})/);
    if (m){ const v = Number(m[1]); return Number.isFinite(v)? v : null; }
    if (raw in DIGIT_MAP) return DIGIT_MAP[raw];

    const tensWords = [
      {k:["„Åò„ÇÖ„ÅÜ","ÂçÅ"], v:10},
      {k:["„Å´„Åò„ÇÖ„ÅÜ","‰∫åÂçÅ"], v:20},
      {k:["„Åï„Çì„Åò„ÇÖ„ÅÜ","‰∏âÂçÅ"], v:30},
      {k:["„Çà„Çì„Åò„ÇÖ„ÅÜ","„Åó„Åò„ÇÖ„ÅÜ","ÂõõÂçÅ"], v:40},
      {k:["„Åî„Åò„ÇÖ„ÅÜ","‰∫îÂçÅ"], v:50},
      {k:["„Çç„Åè„Åò„ÇÖ„ÅÜ","ÂÖ≠ÂçÅ"], v:60},
      {k:["„Å™„Å™„Åò„ÇÖ„ÅÜ","„Åó„Å°„Åò„ÇÖ„ÅÜ","‰∏ÉÂçÅ"], v:70},
      {k:["„ÅØ„Å°„Åò„ÇÖ„ÅÜ","ÂÖ´ÂçÅ"], v:80},
      {k:["„Åç„ÇÖ„ÅÜ„Åò„ÇÖ„ÅÜ","„Åè„Åò„ÇÖ„ÅÜ","‰πùÂçÅ"], v:90},
    ];
    for (const t of tensWords){
      for (const kk of t.k){
        if (raw === kk) return t.v;
        if (raw.startsWith(kk)){
          const rest = raw.slice(kk.length);
          if (!rest) return t.v;
          if (rest in DIGIT_MAP) return t.v + DIGIT_MAP[rest];
        }
      }
    }
    return null;
  }

  // ---------- Game selection state ----------
  const COURSE = { ASC:"asc", DESC:"desc", RAND:"rand" };

  let activeCourse = null; // locked once set
  let ascDans = new Set();  // selected multiple
  let descDans = new Set();
  let randCount = 10;
  let ascStarOn = false;
  let descStarOn = false;

  function lockToCourse(course){
    if (activeCourse && activeCourse !== course) return;
    if (!activeCourse){
      activeCourse = course;
      updateLockUI();
    }
  }
  function updateLockUI(){
    rowAsc.classList.toggle("locked", activeCourse && activeCourse !== COURSE.ASC);
    rowDesc.classList.toggle("locked", activeCourse && activeCourse !== COURSE.DESC);
    rowRand.classList.toggle("locked", activeCourse && activeCourse !== COURSE.RAND);

    setDisabledRow(rowAsc, activeCourse && activeCourse !== COURSE.ASC);
    setDisabledRow(rowDesc, activeCourse && activeCourse !== COURSE.DESC);
    setDisabledRow(rowRand, activeCourse && activeCourse !== COURSE.RAND);
  }
  function setDisabledRow(rowEl, disabled){
    rowEl.querySelectorAll("button").forEach(b=>{
      if (disabled){
        b.disabled = true;
        b.classList.add("disabled");
      }else{
        b.disabled = false;
        b.classList.remove("disabled");
      }
    });
  }

  function makeDanButtons(container, setRef, course){
    container.innerHTML = "";
    for (let i=1;i<=9;i++){
      const b = document.createElement("button");
      b.className = "btn choiceBtn";
      b.textContent = String(i);
      b.addEventListener("click", ()=>{
        lockToCourse(course);
        if (activeCourse !== course) return;
        if (setRef.has(i)) setRef.delete(i);
        else setRef.add(i);
        b.classList.toggle("on", setRef.has(i));
      });
      container.appendChild(b);
    }
  }

  function makeRandButtons(container){
    container.innerHTML = "";
    [10,20,30,40,50].forEach(n=>{
      const b = document.createElement("button");
      b.className = "btn choiceBtn";
      b.textContent = String(n);
      b.addEventListener("click", ()=>{
        lockToCourse(COURSE.RAND);
        if (activeCourse !== COURSE.RAND) return;
        randCount = n;
        [...container.children].forEach(x=>x.classList.remove("on"));
        b.classList.add("on");
      });
      container.appendChild(b);
    });
    container.children[0].classList.add("on");
  }

  function updateStarUI(){
    ascStar.classList.toggle("on", ascStarOn);
    descStar.classList.toggle("on", descStarOn);
  }

  ascStar.addEventListener("click", ()=>{
    lockToCourse(COURSE.ASC);
    if (activeCourse !== COURSE.ASC) return;
    ascStarOn = !ascStarOn;
    updateStarUI();
  });
  descStar.addEventListener("click", ()=>{
    lockToCourse(COURSE.DESC);
    if (activeCourse !== COURSE.DESC) return;
    descStarOn = !descStarOn;
    updateStarUI();
  });

  // ---------- Quiz state ----------
  const LIMIT_MS = 5000;
  const LIMIT_SEC = 5;

  let running = false;     // session active
  let paused  = true;      // in quiz screen, play/stop toggles
  let lockedNext = false;

  let questionPool = [];
  let totalQuestions = 0;
  let idx = 0;
  let good = 0;
  let bad  = 0;
  let current = null;

  let tStart = 0;
  let tickTimer = null;
  let lastShownSec = 5;

  function setSegsOn(n){
    for (let i=0;i<segEls.length;i++){
      segEls[i].classList.toggle("on", i < n);
    }
  }

  function flash(goodFlag){
    const card = $("mainCard");
    card.classList.remove("flashGood","flashBad");
    void card.offsetWidth;
    card.classList.add(goodFlag ? "flashGood" : "flashBad");
  }

  function updateScoreUI(){
    bitQ.textContent = `${Math.min(idx, totalQuestions)}/${totalQuestions}`;
    bitGood.textContent = String(good);
    bitBad.textContent = String(bad);
  }

  function speakQuestion(q){
    speak(`${q.chant}„ÄÇ`, {rate:1.22, pitch:1.05});
  }

  function shuffle(arr){
    for (let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]] = [arr[j],arr[i]];
    }
    return arr;
  }

  function buildPoolAscDesc(course){
    const isAsc = (course === COURSE.ASC);
    const dans = isAsc ? [...ascDans] : [...descDans];
    if (dans.length === 0) return [];
    dans.sort((a,b)=>a-b);
    const bOrder = isAsc ? [1,2,3,4,5,6,7,8,9] : [9,8,7,6,5,4,3,2,1];

    const pool = [];
    for (const a of dans){
      for (const b of bOrder){
        const it = KUKU[a][b];
        pool.push({a,b,chant: it.chant, ans: it.ans});
      }
    }

    const starOn = isAsc ? ascStarOn : descStarOn;
    if (starOn) shuffle(pool);
    return pool;
  }

  function buildPoolRand(){
    const all = [];
    for (let a=1;a<=9;a++){
      for (let b=1;b<=9;b++){
        all.push({a,b, chant: KUKU[a][b].chant, ans: KUKU[a][b].ans});
      }
    }
    shuffle(all);
    return all.slice(0, randCount);
  }

  function startGame(course){
    ensureAudioCtx();
    stopRecognition();
    window.speechSynthesis && window.speechSynthesis.cancel();

    activeCourse = course;
    updateLockUI();

    if (course === COURSE.RAND) questionPool = buildPoolRand();
    else questionPool = buildPoolAscDesc(course);

    if (!questionPool.length){
      setMascot("üòÖ", "<b>„Å†„Çì„Çí „Åà„Çâ„Çì„Åß„Å≠ÔºÅ</b>", "Ôºà1„Äú9 „Çí „Å≤„Å®„Å§„ÅÑ„Åò„Çá„ÅÜÔºâ");
      return;
    }

    totalQuestions = questionPool.length;
    idx = 0;
    good = 0;
    bad  = 0;
    current = null;

    running = true;
    paused = false;
    lockedNext = false;

    setMascot("ü§ñ", "<b>„ÇØ„ÉÉ„ÇØÂÖàÁîüÔºö„ÅÑ„Åè„ÇàÔºÅ</b>", "5„Å≥„Çá„ÅÜ „ÅÑ„Å™„ÅÑ„Å´ „Åì„Åü„Åà„Å¶„Å≠");
    setScreen("quiz");
    updateScoreUI();
    setPlayStopIcon();
    nextQuestion();
  }

  function setPlayStopIcon(){
    playStopIcon.textContent = paused ? "‚ñ∂" : "‚è∏";
  }

  function stopTimers(){
    if (tickTimer) clearInterval(tickTimer);
    tickTimer = null;
  }

  function pauseGame(){
    if (!running) return;
    paused = true;
    lockedNext = true;
    stopRecognition();
    stopTimers();
    window.speechSynthesis && window.speechSynthesis.cancel();
    setPlayStopIcon();
    setMascot(rand(FACES), "<b>„Çπ„Éà„ÉÉ„ÉóÔºÅ</b>", "‚ñ∂ „Åß „Åï„ÅÑ„Åã„ÅÑ");
  }

  function resumeGame(){
    if (!running) return;
    paused = false;
    lockedNext = false;
    setPlayStopIcon();
    setMascot("ü§ñ", "<b>„Åï„ÅÑ„Åã„ÅÑÔºÅ</b>", "");
    startTimer();
    if (recognitionOK){
      setTimeout(()=>{ if (running && !paused && !lockedNext) startRecognition(); }, 180);
    } else {
      fallbackQuiz.classList.remove("hidden");
    }
  }

  playStopBtn.addEventListener("click", ()=>{
    ensureAudioCtx();
    if (!running){
      setMascot("ü§ñ", "<b>„Ç≤„Éº„É†„Çí „Åà„Çâ„Çì„Åß„Å≠ÔºÅ</b>", "");
      return;
    }
    if (paused) resumeGame();
    else pauseGame();
  });

  function startTimer(){
    stopTimers();
    tStart = performance.now();
    lastShownSec = LIMIT_SEC;
    setSegsOn(LIMIT_SEC);

    tickTimer = setInterval(()=>{
      if (!running || paused) return;
      const now = performance.now();
      const left = LIMIT_MS - (now - tStart);
      const secLeft = Math.max(0, Math.ceil(left/1000));
      if (secLeft !== lastShownSec){
        if (secLeft < lastShownSec) playTick();
        lastShownSec = secLeft;
        setSegsOn(secLeft);
      }
      if (left <= 0) timeUp();
    }, 50);
  }

  function timeUp(){
    if (!running || paused || lockedNext) return;
    bad += 1;
    updateScoreUI();
    setMascot("üòµ‚Äçüí´", "<b>„Éñ„ÉÉ„Éñ„ÉºÔºÅ</b>", "");
    flash(false);
    playWrong();
    lockAndAdvance(360);
  }

  function nextQuestion(){
    if (!running) return;
    stopRecognition();
    window.speechSynthesis && window.speechSynthesis.cancel();

    if (idx >= totalQuestions){
      finish();
      return;
    }

    current = questionPool[idx];
    idx += 1;

    qMath.textContent = `${current.a} √ó ${current.b}`;
    qYomi.textContent = current.chant;
    updateScoreUI();

    lockedNext = false;
    paused = false;
    setPlayStopIcon();

    speakQuestion(current);
    startTimer();

    if (recognitionOK){
      setTimeout(()=>{ if (running && !paused && !lockedNext) startRecognition(); }, 240);
    } else {
      fallbackQuiz.classList.remove("hidden");
    }
  }

  function lockAndAdvance(delayMs){
    lockedNext = true;
    stopRecognition();
    stopTimers();
    setTimeout(()=>{ if (running && !paused) nextQuestion(); }, delayMs);
  }

  function handleAnswer(transcript){
    if (!running || paused || lockedNext) return;
    const n = parseNumberJapanese(transcript);
    const ok = (n !== null && current && n === current.ans);

    if (ok){
      good += 1;
      updateScoreUI();
      setMascot(rand(FACES), "<b>„ÅÑ„ÅÑ„Å≠ÔºÅ</b>", "");
      flash(true);
      playCorrect();
      lockAndAdvance(300);
    }else{
      bad += 1;
      updateScoreUI();
      setMascot("üòµ‚Äçüí´", "<b>„Éñ„ÉÉ„Éñ„ÉºÔºÅ</b>", "");
      flash(false);
      playWrong();
      lockAndAdvance(360);
    }
  }

  function finish(){
    running = false;
    paused = true;
    lockedNext = true;
    stopRecognition();
    stopTimers();
    window.speechSynthesis && window.speechSynthesis.cancel();

    playCheerAndClap();
    resultLine.textContent = `‚≠ï ${good} / ${totalQuestions}„ÄÄÔºà‚ùå ${bad}Ôºâ`;
    setMascot("üéâ", "<b>„ÇØ„É™„Ç¢ÔºÅ</b>", "„ÇÑ„Å£„Åü„Å≠ÔºÅ");
    setScreen("result");
  }

  beginBtnAsc.addEventListener("click", ()=>{
    lockToCourse(COURSE.ASC);
    if (activeCourse !== COURSE.ASC) return;
    startGame(COURSE.ASC);
  });
  beginBtnDesc.addEventListener("click", ()=>{
    lockToCourse(COURSE.DESC);
    if (activeCourse !== COURSE.DESC) return;
    startGame(COURSE.DESC);
  });
  beginBtnRand.addEventListener("click", ()=>{
    lockToCourse(COURSE.RAND);
    if (activeCourse !== COURSE.RAND) return;
    startGame(COURSE.RAND);
  });

  againBtn.addEventListener("click", ()=>{
    if (!activeCourse) { setScreen("start"); return; }
    startGame(activeCourse);
  });
  backBtn.addEventListener("click", ()=>{
    resetAll();
  });

  soundBtn.addEventListener("click", ()=>{
    ensureAudioCtx();
    playTick();
    setTimeout(()=>playCorrect(), 140);
    setTimeout(()=>playWrong(), 520);
    setMascot(rand(FACES), "<b>„Åä„Å® „ÉÜ„Çπ„ÉàÔºÅ</b>", "„Åç„Åì„Åà„ÅüÔºü");
  });

  resetBtn.addEventListener("click", ()=>{
    resetAll();
  });

  function resetAll(){
    running = false;
    paused = true;
    lockedNext = true;
    stopRecognition();
    stopTimers();
    window.speechSynthesis && window.speechSynthesis.cancel();

    activeCourse = null;
    ascDans = new Set();
    descDans = new Set();
    randCount = 10;
    ascStarOn = false;
    descStarOn = false;

    [...ascChoices.children].forEach(b=>b.classList.remove("on"));
    [...descChoices.children].forEach(b=>b.classList.remove("on"));
    [...randChoices.children].forEach((b,i)=>b.classList.toggle("on", i===0));
    updateStarUI();
    updateLockUI();

    setMascot("ü§ñ", "<b>„Ç≤„Éº„É†„Çí„Åà„Çâ„Çì„Åß„Å≠ÔºÅ</b>", "Ôºà„Éû„Ç§„ÇØ„ÅÆ „Åç„Çá„Åã„Åå „Å≤„Å§„Çà„ÅÜ„Å†„ÇàÔºâ");
    setSegsOn(LIMIT_SEC);
    setScreen("start");
  }

  function renderKeypad(){
    kbdQuiz.innerHTML = "";
    for (let n=0; n<=9; n++){
      const b = document.createElement("button");
      b.className = "btn";
      b.textContent = String(n);
      b.addEventListener("click", ()=>{
        if (!running || paused || lockedNext) return;
        handleAnswer(String(n));
      });
      kbdQuiz.appendChild(b);
    }
  }
  renderKeypad();

  makeDanButtons(ascChoices, ascDans, COURSE.ASC);
  makeDanButtons(descChoices, descDans, COURSE.DESC);
  makeRandButtons(randChoices);
  updateStarUI();
  updateLockUI();

  setupRecognition();
  if (!recognitionOK){
    fallbackQuiz.classList.remove("hidden");
    setMascot("üòµ‚Äçüí´", "<b>Èü≥Â£∞„Å´„Çì„Åó„Åç„Åå „Å§„Åã„Åà„Å™„ÅÑ‚Ä¶</b>", "Ôºà„ÉÜ„Çπ„Éà„ÅØ „Çø„ÉÉ„Éó„ÅßOKÔºâ");
  }
</script>
</body>
</html>
