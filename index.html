<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>ä¹ä¹ã‚’éŸ³ã§ãŠã¼ãˆã‚‹</title>
  <style>
    :root{
      --bg:#0b1220;
      --card: rgba(255,255,255,.06);
      --line: rgba(255,255,255,.12);
      --text:#e8eefc;
      --muted:#a8b3d4;
      --accent:#7dd3fc;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --r: 22px;
    }
    *{ box-sizing:border-box; }
    html, body { height: 100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Sans", "Noto Sans JP", sans-serif;
      color:var(--text);
      background:
        radial-gradient(1000px 700px at 20% 10%, rgba(125,211,252,.18), transparent 60%),
        radial-gradient(900px 650px at 80% 25%, rgba(134,239,172,.12), transparent 55%),
        radial-gradient(900px 650px at 40% 90%, rgba(252,165,165,.10), transparent 55%),
        var(--bg);
      overflow:hidden;
    }
    .app{
      height: 100%;
      max-width: 900px;
      margin: 0 auto;
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }
    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      user-select:none;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }
    .logo{
      width:40px;height:40px;border-radius:14px;
      background: linear-gradient(135deg, rgba(125,211,252,.95), rgba(134,239,172,.85));
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      flex: 0 0 auto;
    }
    .brandText{ display:flex; flex-direction:column; line-height:1.05; min-width:0; }
    .brandText b{
      font-size: 16px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brandText span{
      font-size: 12px;
      color: #a8b3d4;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .btn{
      appearance:none;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: #e8eefc;
      border-radius: 16px;
      padding: 10px 12px;
      font-weight: 900;
      cursor:pointer;
      box-shadow: 0 8px 18px rgba(0,0,0,.22);
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(125,211,252,.28), rgba(134,239,172,.18));
      border-color: rgba(125,211,252,.30);
    }
    .btn.ghost{ background: rgba(255,255,255,.05); }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      color: #a8b3d4;
      font-size: 12px;
      font-weight: 800;
      white-space:nowrap;
    }

    .card{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 22px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      padding: 14px;
    }

    .main{
      flex: 1;
      display:flex;
      flex-direction:column;
      gap: 12px;
      min-height: 0;
    }

    .topRow{
      display:flex;
      gap: 12px;
      align-items:stretch;
      flex-wrap:wrap;
    }
    .topRow .card{ flex:1; min-width: 260px; }

    .mascot{
      display:flex;
      gap: 12px;
      align-items:center;
    }
    .face{
      width:64px;height:64px;border-radius:22px;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.25), transparent 35%),
                  linear-gradient(135deg, rgba(125,211,252,.9), rgba(167,139,250,.55));
      display:flex;align-items:center;justify-content:center;
      font-size: 36px;
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
      position:relative;
      overflow:hidden;
      flex: 0 0 auto;
    }
    .face::after{
      content:"";
      position:absolute; inset:-40%;
      background: linear-gradient(120deg, transparent, rgba(255,255,255,.16), transparent);
      transform: rotate(20deg);
      animation: shine 7s linear infinite;
    }
    @keyframes shine{
      0%{transform: translateX(-40%) rotate(20deg)}
      100%{transform: translateX(140%) rotate(20deg)}
    }
    .bubble{
      flex: 1;
      background: rgba(15, 23, 42, .65);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      padding: 10px 12px;
      min-height: 56px;
      line-height: 1.35;
      position:relative;
    }
    .bubble::before{
      content:"";
      position:absolute;
      left:-10px; top:18px;
      width:18px; height:18px;
      background: rgba(15, 23, 42, .65);
      border-left: 1px solid rgba(255,255,255,.12);
      border-bottom: 1px solid rgba(255,255,255,.12);
      transform: rotate(45deg);
    }
    .bubble b{ color: #7dd3fc; }

    .quiz{
      flex:1;
      display:flex;
      flex-direction:column;
      gap: 12px;
      min-height: 0;
    }
    .questionCard{
      flex: 1;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      text-align:center;
      gap: 10px;
      min-height: 0;
    }
    .qMath{
      font-size: clamp(44px, 7vw, 72px);
      font-weight: 1000;
      letter-spacing: .5px;
    }
    .qYomi{
      font-size: clamp(18px, 3.5vw, 28px);
      font-weight: 900;
      color: #7dd3fc;
    }
    .qSub{
      color: #a8b3d4;
      font-size: 13px;
      font-weight: 800;
      margin-top: 2px;
    }

    .segmeter{
      width: min(620px, 100%);
      display:flex;
      gap: 8px;
      align-items:center;
      justify-content:center;
      margin-top: 6px;
    }
    .seg{
      flex: 1 1 0;
      height: 16px;
      border-radius: 10px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      overflow:hidden;
      position:relative;
    }
    .seg.on::before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, rgba(125,211,252,.9), rgba(134,239,172,.9));
    }

    .bottomRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      flex-wrap:wrap;
    }
    .statusLine{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .flashGood{ animation: flashGood .28s ease; }
    .flashBad{ animation: flashBad .28s ease; }
    @keyframes flashGood{
      0%{ box-shadow: 0 10px 30px rgba(0,0,0,.35); border-color: rgba(134,239,172,.3); }
      40%{ box-shadow: 0 0 0 4px rgba(134,239,172,.18), 0 10px 30px rgba(0,0,0,.35); border-color: rgba(134,239,172,.55); }
      100%{ box-shadow: 0 10px 30px rgba(0,0,0,.35); border-color: rgba(255,255,255,.12); }
    }
    @keyframes flashBad{
      0%{ box-shadow: 0 10px 30px rgba(0,0,0,.35); border-color: rgba(252,165,165,.3); }
      40%{ box-shadow: 0 0 0 4px rgba(252,165,165,.18), 0 10px 30px rgba(0,0,0,.35); border-color: rgba(252,165,165,.55); }
      100%{ box-shadow: 0 10px 30px rgba(0,0,0,.35); border-color: rgba(255,255,255,.12); }
    }
    .hidden{ display:none !important; }

    .fallback{
      display:flex;
      flex-direction:column;
      gap: 10px;
      width: min(620px, 100%);
      margin-top: 8px;
    }
    .kbd{
      display:grid;
      grid-template-columns: repeat(5, minmax(0,1fr));
      gap: 8px;
    }
    .kbd .btn{
      padding: 12px 10px;
      border-radius: 14px;
      font-size: 18px;
    }
    .tiny{
      font-size: 12px;
      color: #a8b3d4;
      line-height: 1.4;
    }
  </style>
</head>

<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="brandText">
          <b>ä¹ä¹ã‚’éŸ³ã§ãŠã¼ãˆã‚‹</b>
          <span>ã‚‚ã‚“ã ã„ã¯ ã¿ã‚‹ï¼‹ããï½œã“ãŸãˆã¯ ã“ãˆã§</span>
        </div>
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button class="btn ghost" id="soundBtn" title="ãŠã¨ãƒ†ã‚¹ãƒˆ">â™ª</button>
        <button class="btn" id="resetBtn" title="ã•ã„ã—ã‚‡ã‹ã‚‰">â†º</button>
      </div>
    </header>

    <div class="main">
      <div class="topRow">
        <div class="card">
          <div class="mascot">
            <div class="face" id="face" aria-hidden="true">ğŸ¤–</div>
            <div class="bubble">
              <div id="bubbleMain"><b>ãƒ«ãƒ¼ãƒ«</b>ï¼šã‚‚ã‚“ã ã„ãŒã§ãŸã‚‰ 5ã³ã‚‡ã† ã„ãªã„ã« ã“ãŸãˆã¦ã­ã€‚</div>
              <div class="tiny" id="bubbleSub" style="margin-top:6px;">ï¼ˆãƒã‚¤ã‚¯ã‚’ã¤ã‹ã†ã‚ˆã€‚ã¯ã˜ã‚ã«ã€Œã‚¹ã‚¿ãƒ¼ãƒˆã€ã‚’ãŠã—ã¦ã­ï¼‰</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="statusLine">
            <span class="pill" id="pillQ">ã‚‚ã‚“ã ã„ 0/20</span>
            <span class="pill" id="pillScore">ã›ã„ã‹ã„ 0</span>
            <span class="pill" id="pillState">ã¾ã„ã ã¾ã¡</span>
          </div>
          <div class="tiny" style="margin-top:10px;">
            ãƒ»ã“ãŸãˆã¯ <b>ã™ã†ã˜</b> ã§ã‚‚ <b>ã“ã¨ã°</b> ã§ã‚‚OKï¼ˆä¾‹ï¼š8 / ã¯ã¡ï¼‰<br/>
            ãƒ»1ã‚‚ã‚“ 5ã³ã‚‡ã†ã€‚ã˜ã‹ã‚“ãã‚Œã§ã‚‚ ã¤ãã¸ã€‚
          </div>
          <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn primary" id="startBtn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
            <button class="btn" id="stopBtn">ã¨ã‚ã‚‹</button>
          </div>
        </div>
      </div>

      <div class="quiz card" id="quizCard">
        <div class="questionCard" id="screenIntro">
          <div class="qMath">ä¹ä¹ã‚¯ã‚¤ã‚º</div>
          <div class="qYomi">ã“ãˆã§ ã“ãŸãˆã‚ˆã†</div>

          <div class="segmeter" aria-label="countdown preview">
            <div class="seg on"></div><div class="seg on"></div><div class="seg on"></div><div class="seg on"></div><div class="seg on"></div>
          </div>

          <div class="fallback hidden" id="fallbackInfo">
            <div class="tiny">
              ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ <b>éŸ³å£°å›ç­”</b> ãŒä½¿ãˆãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚<br/>
              ã§ãã‚Œã° <b>Android: Chrome</b> ã‚’ãŠã™ã™ã‚ã€‚<br/>
              ãƒ†ã‚¹ãƒˆç”¨ã«ã€ã“ã“ã« <b>ã‚¿ãƒƒãƒ—å›ç­”</b> ã‚’å‡ºã—ã¾ã™ï¼ˆéŸ³å£°ãŒä½¿ãˆãªã„ã¨ãã®ã¿ï¼‰ã€‚
            </div>
            <div class="kbd" id="kbdIntro"></div>
          </div>
        </div>

        <div class="questionCard hidden" id="screenQuiz">
          <div class="qMath" id="qMath">2 Ã— 1</div>
          <div class="qYomi" id="qYomi">ã«ã„ã¡ãŒ</div>
          <div class="qSub">ã“ãŸãˆã‚’ ã“ãˆã§ ã„ã£ã¦ã­</div>

          <div class="segmeter" aria-label="countdown">
            <div class="seg on" id="seg1"></div>
            <div class="seg on" id="seg2"></div>
            <div class="seg on" id="seg3"></div>
            <div class="seg on" id="seg4"></div>
            <div class="seg on" id="seg5"></div>
          </div>

          <div class="fallback hidden" id="fallbackQuiz">
            <div class="kbd" id="kbdQuiz"></div>
            <div class="tiny">ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼šã‚¿ãƒƒãƒ—ã§ã‚‚OKï¼‰</div>
          </div>
        </div>

        <div class="questionCard hidden" id="screenResult">
          <div class="qMath">ãŠã¤ã‹ã‚Œã•ã¾ï¼</div>
          <div class="qYomi" id="resultScore">ã›ã„ã‹ã„ 0 / 20</div>
          <div class="qSub" id="resultMsg">ã¾ãŸ ã‚„ã£ã¦ã¿ã‚ˆã†ï¼</div>
          <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
            <button class="btn primary" id="againBtn">ã‚‚ã†ã„ã¡ã©</button>
            <button class="btn" id="backBtn">ã‚‚ã©ã‚‹</button>
          </div>
          <div class="tiny" style="margin-top:10px;">
            â€»èª­ã¿ä¸Šã’ãŒèã“ãˆãªã„ã¨ãã¯ã€å³ä¸Šã®ã€Œâ™ªã€ã‚’1å›ãŠã—ã¦ã­ã€‚
          </div>
        </div>
      </div>

      <div class="bottomRow">
        <div class="statusLine">
          <span class="pill" id="pillLast">ã•ã„ã”ï¼šâ€”</span>
          <span class="pill" id="pillTime">ã®ã“ã‚Š 5s</span>
        </div>
        <div class="tiny">â€»ã¯ã˜ã‚ã¦ã¯ ãƒã‚¤ã‚¯ã® ãã‚‡ã‹ãŒ ã²ã¤ã‚ˆã†ã§ã™</div>
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    const face = $("face");
    const bubbleMain = $("bubbleMain");
    const bubbleSub = $("bubbleSub");
    const pillQ = $("pillQ");
    const pillScore = $("pillScore");
    const pillState = $("pillState");
    const pillLast = $("pillLast");
    const pillTime = $("pillTime");
    const startBtn = $("startBtn");
    const stopBtn = $("stopBtn");
    const resetBtn = $("resetBtn");
    const soundBtn = $("soundBtn");
    const screenIntro = $("screenIntro");
    const screenQuiz = $("screenQuiz");
    const screenResult = $("screenResult");
    const qMath = $("qMath");
    const qYomi = $("qYomi");
    const resultScore = $("resultScore");
    const resultMsg = $("resultMsg");
    const againBtn = $("againBtn");
    const backBtn = $("backBtn");
    const fallbackInfo = $("fallbackInfo");
    const fallbackQuiz = $("fallbackQuiz");
    const kbdIntro = $("kbdIntro");
    const kbdQuiz = $("kbdQuiz");
    const segEls = [$("seg1"),$("seg2"),$("seg3"),$("seg4"),$("seg5")];

    const KUKU = {
      1:{1:{chant:"ã„ã‚“ã„ã¡ãŒ",answerYomi:"ã„ã¡",ans:1},2:{chant:"ã„ã‚“ã«ãŒ",answerYomi:"ã«",ans:2},3:{chant:"ã„ã‚“ã•ã‚“ãŒ",answerYomi:"ã•ã‚“",ans:3},4:{chant:"ã„ã‚“ã—ãŒ",answerYomi:"ã—",ans:4},5:{chant:"ã„ã‚“ã”ãŒ",answerYomi:"ã”",ans:5},6:{chant:"ã„ã‚“ã‚ããŒ",answerYomi:"ã‚ã",ans:6},7:{chant:"ã„ã‚“ã—ã¡ãŒ",answerYomi:"ã—ã¡",ans:7},8:{chant:"ã„ã‚“ã¯ã¡ãŒ",answerYomi:"ã¯ã¡",ans:8},9:{chant:"ã„ã‚“ããŒ",answerYomi:"ã",ans:9}},
      2:{1:{chant:"ã«ã„ã¡ãŒ",answerYomi:"ã«",ans:2},2:{chant:"ã«ã«ã‚“ãŒ",answerYomi:"ã—",ans:4},3:{chant:"ã«ã•ã‚“ãŒ",answerYomi:"ã‚ã",ans:6},4:{chant:"ã«ã—ãŒ",answerYomi:"ã¯ã¡",ans:8},5:{chant:"ã«ã”",answerYomi:"ã˜ã‚…ã†",ans:10},6:{chant:"ã«ã‚ã",answerYomi:"ã˜ã‚…ã†ã«",ans:12},7:{chant:"ã«ã—ã¡",answerYomi:"ã˜ã‚…ã†ã—",ans:14},8:{chant:"ã«ã¯ã¡",answerYomi:"ã˜ã‚…ã†ã‚ã",ans:16},9:{chant:"ã«ã",answerYomi:"ã˜ã‚…ã†ã¯ã¡",ans:18}},
      3:{1:{chant:"ã•ã‚“ã„ã¡ãŒ",answerYomi:"ã•ã‚“",ans:3},2:{chant:"ã•ã‚“ã«ãŒ",answerYomi:"ã‚ã",ans:6},3:{chant:"ã•ã–ã‚“ãŒ",answerYomi:"ã",ans:9},4:{chant:"ã•ã‚“ã—",answerYomi:"ã˜ã‚…ã†ã«",ans:12},5:{chant:"ã•ã‚“ã”",answerYomi:"ã˜ã‚…ã†ã”",ans:15},6:{chant:"ã•ã¶ã‚ã",answerYomi:"ã˜ã‚…ã†ã¯ã¡",ans:18},7:{chant:"ã•ã‚“ã—ã¡",answerYomi:"ã«ã˜ã‚…ã†ã„ã¡",ans:21},8:{chant:"ã•ã‚“ã±",answerYomi:"ã«ã˜ã‚…ã†ã—",ans:24},9:{chant:"ã•ã‚“ã",answerYomi:"ã«ã˜ã‚…ã†ã—ã¡",ans:27}},
      4:{1:{chant:"ã—ã„ã¡ãŒ",answerYomi:"ã—",ans:4},2:{chant:"ã—ã«ãŒ",answerYomi:"ã¯ã¡",ans:8},3:{chant:"ã—ã•ã‚“",answerYomi:"ã˜ã‚…ã†ã«",ans:12},4:{chant:"ã—ã—",answerYomi:"ã˜ã‚…ã†ã‚ã",ans:16},5:{chant:"ã—ã”",answerYomi:"ã«ã˜ã‚…ã†",ans:20},6:{chant:"ã—ã‚ã",answerYomi:"ã«ã˜ã‚…ã†ã—",ans:24},7:{chant:"ã—ã—ã¡",answerYomi:"ã«ã˜ã‚…ã†ã¯ã¡",ans:28},8:{chant:"ã—ã¯",answerYomi:"ã•ã‚“ã˜ã‚…ã†ã«",ans:32},9:{chant:"ã—ã",answerYomi:"ã•ã‚“ã˜ã‚…ã†ã‚ã",ans:36}},
      5:{1:{chant:"ã”ã„ã¡ãŒ",answerYomi:"ã”",ans:5},2:{chant:"ã”ã«",answerYomi:"ã˜ã‚…ã†",ans:10},3:{chant:"ã”ã•ã‚“",answerYomi:"ã˜ã‚…ã†ã”",ans:15},4:{chant:"ã”ã—",answerYomi:"ã«ã˜ã‚…ã†",ans:20},5:{chant:"ã”ã”",answerYomi:"ã«ã˜ã‚…ã†ã”",ans:25},6:{chant:"ã”ã‚ã",answerYomi:"ã•ã‚“ã˜ã‚…ã†",ans:30},7:{chant:"ã”ã—ã¡",answerYomi:"ã•ã‚“ã˜ã‚…ã†ã”",ans:35},8:{chant:"ã”ã¯",answerYomi:"ã—ã˜ã‚…ã†",ans:40},9:{chant:"ã”ã£ã",answerYomi:"ã—ã˜ã‚…ã†ã”",ans:45}},
      6:{1:{chant:"ã‚ãã„ã¡ãŒ",answerYomi:"ã‚ã",ans:6},2:{chant:"ã‚ãã«",answerYomi:"ã˜ã‚…ã†ã«",ans:12},3:{chant:"ã‚ãã•ã‚“",answerYomi:"ã˜ã‚…ã†ã¯ã¡",ans:18},4:{chant:"ã‚ãã—",answerYomi:"ã«ã˜ã‚…ã†ã—",ans:24},5:{chant:"ã‚ãã”",answerYomi:"ã•ã‚“ã˜ã‚…ã†",ans:30},6:{chant:"ã‚ãã‚ã",answerYomi:"ã•ã‚“ã˜ã‚…ã†ã‚ã",ans:36},7:{chant:"ã‚ãã—ã¡",answerYomi:"ã—ã˜ã‚…ã†ã«",ans:42},8:{chant:"ã‚ãã¯",answerYomi:"ã—ã˜ã‚…ã†ã¯ã¡",ans:48},9:{chant:"ã‚ã£ã",answerYomi:"ã”ã˜ã‚…ã†ã—",ans:54}},
      7:{1:{chant:"ã—ã¡ã„ã¡ãŒ",answerYomi:"ã—ã¡",ans:7},2:{chant:"ã—ã¡ã«",answerYomi:"ã˜ã‚…ã†ã—",ans:14},3:{chant:"ã—ã¡ã•ã‚“",answerYomi:"ã«ã˜ã‚…ã†ã„ã¡",ans:21},4:{chant:"ã—ã¡ã—",answerYomi:"ã«ã˜ã‚…ã†ã¯ã¡",ans:28},5:{chant:"ã—ã¡ã”",answerYomi:"ã•ã‚“ã˜ã‚…ã†ã”",ans:35},6:{chant:"ã—ã¡ã‚ã",answerYomi:"ã—ã˜ã‚…ã†ã«",ans:42},7:{chant:"ã—ã¡ã—ã¡",answerYomi:"ã—ã˜ã‚…ã†ã",ans:49},8:{chant:"ã—ã¡ã¯",answerYomi:"ã”ã˜ã‚…ã†ã‚ã",ans:56},9:{chant:"ã—ã¡ã",answerYomi:"ã‚ãã˜ã‚…ã†ã•ã‚“",ans:63}},
      8:{1:{chant:"ã¯ã¡ã„ã¡ãŒ",answerYomi:"ã¯ã¡",ans:8},2:{chant:"ã¯ã¡ã«",answerYomi:"ã˜ã‚…ã†ã‚ã",ans:16},3:{chant:"ã¯ã¡ã•ã‚“",answerYomi:"ã«ã˜ã‚…ã†ã—",ans:24},4:{chant:"ã¯ã¡ã—",answerYomi:"ã•ã‚“ã˜ã‚…ã†ã«",ans:32},5:{chant:"ã¯ã¡ã”",answerYomi:"ã—ã˜ã‚…ã†",ans:40},6:{chant:"ã¯ã¡ã‚ã",answerYomi:"ã—ã˜ã‚…ã†ã¯ã¡",ans:48},7:{chant:"ã¯ã¡ã—ã¡",answerYomi:"ã”ã˜ã‚…ã†ã‚ã",ans:56},8:{chant:"ã¯ã£ã±",answerYomi:"ã‚ãã˜ã‚…ã†ã—",ans:64},9:{chant:"ã¯ã£ã",answerYomi:"ã—ã¡ã˜ã‚…ã†ã«",ans:72}},
      9:{1:{chant:"ãã„ã¡ãŒ",answerYomi:"ã",ans:9},2:{chant:"ãã«",answerYomi:"ã˜ã‚…ã†ã¯ã¡",ans:18},3:{chant:"ãã•ã‚“",answerYomi:"ã«ã˜ã‚…ã†ã—ã¡",ans:27},4:{chant:"ãã—",answerYomi:"ã•ã‚“ã˜ã‚…ã†ã‚ã",ans:36},5:{chant:"ãã”",answerYomi:"ã—ã˜ã‚…ã†ã”",ans:45},6:{chant:"ãã‚ã",answerYomi:"ã”ã˜ã‚…ã†ã—",ans:54},7:{chant:"ãã—ã¡",answerYomi:"ã‚ãã˜ã‚…ã†ã•ã‚“",ans:63},8:{chant:"ãã¯",answerYomi:"ã—ã¡ã˜ã‚…ã†ã«",ans:72},9:{chant:"ãã",answerYomi:"ã¯ã¡ã˜ã‚…ã†ã„ã¡",ans:81}}
    };

    function speak(text, {rate=1.12, pitch=1.12, volume=1.0} = {}){
      if (!("speechSynthesis" in window) || !("SpeechSynthesisUtterance" in window)) return false;
      try{
        const u = new SpeechSynthesisUtterance(text);
        u.lang = "ja-JP";
        u.rate = rate;
        u.pitch = pitch;
        u.volume = volume;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(u);
        return true;
      }catch{
        return false;
      }
    }

    let audioCtx = null;
    function ensureAudioCtx(){
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === "suspended") audioCtx.resume().catch(()=>{});
      return audioCtx;
    }
    function ping(){
      // legacy: short positive blip (kept for compatibility)
      playCorrect();
    }

    function playTone(freq, duration, {volume=0.12, type="sine", attack=0.008, release=0.03} = {}){
      if (!(window.AudioContext || window.webkitAudioContext)) return;
      try{
        const ctx = ensureAudioCtx();
        const now = ctx.currentTime;

        const g = ctx.createGain();
        g.gain.setValueAtTime(0.0001, now);
        g.gain.linearRampToValueAtTime(volume, now + attack);
        g.gain.setTargetAtTime(0.0001, now + duration, release);
        g.connect(ctx.destination);

        const o = ctx.createOscillator();
        o.type = type;
        o.frequency.setValueAtTime(freq, now);
        o.connect(g);
        o.start(now);
        o.stop(now + duration + 0.08);
      }catch{}
    }

    // 1ç§’ã”ã¨ã®ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ç”¨ï¼ˆå°ã•ã‚ï¼‰
    function playTick(){
      // smaller than correct/wrong
      playTone(1100, 0.05, {volume:0.04, type:"square", attack:0.002, release:0.02});
    }

    // æ­£è§£ï¼šãƒ”ãƒ³ãƒãƒ³ãƒ”ãƒ³ãƒãƒ¼ãƒ³ï¼ˆæ˜ã‚‹ã„2éŸ³ï¼‹ä¼¸ã³ï¼‰
    function playCorrect(){
      if (!(window.AudioContext || window.webkitAudioContext)) return;
      try{
        const ctx = ensureAudioCtx();
        const now = ctx.currentTime;

        const g = ctx.createGain();
        g.gain.setValueAtTime(0.0001, now);
        g.gain.linearRampToValueAtTime(0.14, now + 0.01);
        g.gain.setTargetAtTime(0.0001, now + 0.55, 0.06);
        g.connect(ctx.destination);

        const o = ctx.createOscillator();
        o.type = "sine";
        o.connect(g);

        // ãƒ”ãƒ³ï¼ˆçŸ­ï¼‰
        o.frequency.setValueAtTime(880, now);
        o.frequency.setValueAtTime(988, now + 0.12);

        // ãƒãƒ³ï¼ˆå°‘ã—ä¸‹ï¼‰
        o.frequency.setValueAtTime(784, now + 0.24);

        // ãƒãƒ¼ãƒ³ï¼ˆä¸Šã«ä¼¸ã³ï¼‰
        o.frequency.setValueAtTime(1046, now + 0.34);

        o.start(now);
        o.stop(now + 0.70);
      }catch{}
    }

    // ä¸æ­£è§£ï¼šãƒ–ãƒƒãƒ–ãƒ¼ï¼ˆä½ã‚ã®ãƒ–ã‚¶ãƒ¼ï¼‰
    function playWrong(){
      if (!(window.AudioContext || window.webkitAudioContext)) return;
      try{
        const ctx = ensureAudioCtx();
        const now = ctx.currentTime;

        const g = ctx.createGain();
        g.gain.setValueAtTime(0.0001, now);
        g.gain.linearRampToValueAtTime(0.12, now + 0.01);
        g.gain.setTargetAtTime(0.0001, now + 0.42, 0.08);
        g.connect(ctx.destination);

        const o = ctx.createOscillator();
        o.type = "sawtooth";
        o.frequency.setValueAtTime(180, now);
        // ãƒ–ãƒƒï¼ˆæºã‚‰ã™ï¼‰
        o.frequency.linearRampToValueAtTime(140, now + 0.12);
        // ãƒ–ãƒ¼ï¼ˆå°‘ã—ä¸Šã’ã¦æŒç¶šï¼‰
        o.frequency.setValueAtTime(160, now + 0.20);
        o.frequency.linearRampToValueAtTime(150, now + 0.42);

        o.connect(g);
        o.start(now);
        o.stop(now + 0.55);
      }catch{}
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let rec = null;
    let recognitionOK = !!SpeechRecognition;

    function setupRecognition(){
      if (!recognitionOK) return;
      rec = new SpeechRecognition();
      rec.lang = "ja-JP";
      rec.interimResults = false;
      rec.maxAlternatives = 3;
      rec.continuous = false;

      rec.onstart = () => { pillState.textContent = "ã¾ã„ã ON"; };
      rec.onend = () => { pillState.textContent = running ? "ã¾ã„ã ãã„ã¦ã‚‹â€¦" : "ã¾ã„ã OFF"; };
      rec.onerror = () => {
        pillState.textContent = "ã¾ã„ã NG";
        setMascot("ğŸ˜µâ€ğŸ’«", "<b>ãƒã‚¤ã‚¯ãŒ ã¤ã‹ãˆãªã„ã¿ãŸã„â€¦</b>", "ãã‚‡ã‹ï¼ˆè¨±å¯ï¼‰ã‚’ ã‹ãã«ã‚“ã—ã¦ã­");
      };
      rec.onresult = (ev) => {
        if (!running || lockedNext) return;
        const res = ev.results?.[0];
        if (!res) return;
        const transcript = String(res[0].transcript || "").trim();
        handleAnswer(transcript);
      };
    }

    const DIGIT_MAP = {"ãœã‚":0,"ã‚Œã„":0,"0":0,"ã€‡":0,"é›¶":0,"ã„ã¡":1,"1":1,"ä¸€":1,"ã«":2,"2":2,"äºŒ":2,"ã•ã‚“":3,"3":3,"ä¸‰":3,"ã—":4,"ã‚ˆã‚“":4,"4":4,"å››":4,"ã”":5,"5":5,"äº”":5,"ã‚ã":6,"6":6,"å…­":6,"ãªãª":7,"ã—ã¡":7,"7":7,"ä¸ƒ":7,"ã¯ã¡":8,"8":8,"å…«":8,"ãã‚…ã†":9,"ã":9,"9":9,"ä¹":9};

    function normalizeKana(s){
      return String(s || "").toLowerCase().replace(/\s+/g, "").replace(/ãƒ¼/g,"").replace(/[ï¼Œ,ã€‚ï¼.ï¼!ï¼Ÿ?]/g,"");
    }

    function parseNumberJapanese(input){
      const raw = normalizeKana(input);
      if (!raw) return null;

      const m = raw.match(/(\d{1,3})/);
      if (m) {
        const v = Number(m[1]);
        return Number.isFinite(v) ? v : null;
      }
      if (raw in DIGIT_MAP) return DIGIT_MAP[raw];

      const tensWords = [
        {k:["ã˜ã‚…ã†","å"], v:10},
        {k:["ã«ã˜ã‚…ã†","äºŒå"], v:20},
        {k:["ã•ã‚“ã˜ã‚…ã†","ä¸‰å"], v:30},
        {k:["ã‚ˆã‚“ã˜ã‚…ã†","ã—ã˜ã‚…ã†","å››å"], v:40},
        {k:["ã”ã˜ã‚…ã†","äº”å"], v:50},
        {k:["ã‚ãã˜ã‚…ã†","å…­å"], v:60},
        {k:["ãªãªã˜ã‚…ã†","ã—ã¡ã˜ã‚…ã†","ä¸ƒå"], v:70},
        {k:["ã¯ã¡ã˜ã‚…ã†","å…«å"], v:80},
        {k:["ãã‚…ã†ã˜ã‚…ã†","ãã˜ã‚…ã†","ä¹å"], v:90},
      ];
      for (const t of tensWords){
        for (const kk of t.k){
          if (raw === kk) return t.v;
          if (raw.startsWith(kk)){
            const rest = raw.slice(kk.length);
            if (!rest) return t.v;
            if (rest in DIGIT_MAP) return t.v + DIGIT_MAP[rest];
          }
        }
      }
      return null;
    }

    const TOTAL = 20;
    const LIMIT_MS = 5000;
    const LIMIT_SEC = 5;

    let running = false;
    let idx = 0;
    let score = 0;
    let current = null;
    let tickTimer = null;
    let tStart = 0;
    let lastTranscript = "";
    let lockedNext = false;
    let lastShownSec = 5;

    const FACES = ["ğŸ¤–","ğŸ¦Š","ğŸ¸","ğŸ¼","ğŸ¦‰","ğŸ™","ğŸ§ ","ğŸš€"];
    function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    function setMascot(emoji, main, sub){
      face.textContent = emoji;
      bubbleMain.innerHTML = main;
      bubbleSub.textContent = sub || "";
    }

    function setScreen(which){
      screenIntro.classList.toggle("hidden", which !== "intro");
      screenQuiz.classList.toggle("hidden", which !== "quiz");
      screenResult.classList.toggle("hidden", which !== "result");
    }

    function updatePills(){
      pillQ.textContent = `ã‚‚ã‚“ã ã„ ${Math.min(idx, TOTAL)}/${TOTAL}`;
      pillScore.textContent = `ã›ã„ã‹ã„ ${score}`;
      pillLast.textContent = lastTranscript ? `ã•ã„ã”ï¼š${lastTranscript}` : "ã•ã„ã”ï¼šâ€”";
    }

    function setTimeLeftSec(sec){
      const s = Math.max(0, Math.min(LIMIT_SEC, sec));
      pillTime.textContent = `ã®ã“ã‚Š ${s}s`;
    }

    function setSegsOn(n){
      for (let i=0;i<segEls.length;i++){
        segEls[i].classList.toggle("on", i < n);
      }
    }

    function genQuestion(){
      const a = 1 + Math.floor(Math.random()*9);
      const b = 1 + Math.floor(Math.random()*9);
      const it = KUKU[a][b];
      return {a,b, chant: it.chant, answerYomi: it.answerYomi, ans: it.ans};
    }

    function stopRecognition(){ try{ rec && rec.stop(); }catch{} }
    function startRecognition(){
      if (!recognitionOK) return;
      try{ rec.start(); }catch{}
    }

    function speakQuestion(q){ speak(`${q.chant}ã€‚`, {rate:1.20, pitch:1.08}); }
    function speakFull(q){ /* feedback disabled */ }

    function startTimer(){
      tStart = performance.now();
      lastShownSec = LIMIT_SEC;
      setTimeLeftSec(LIMIT_SEC);
      setSegsOn(LIMIT_SEC);

      if (tickTimer) clearInterval(tickTimer);
      tickTimer = setInterval(()=>{
        if (!running || lockedNext) return;
        const now = performance.now();
        const elapsed = now - tStart;
        const left = LIMIT_MS - elapsed;

        const secLeft = Math.max(0, Math.ceil(left / 1000));
        if (secLeft !== lastShownSec){
          // 1ç§’æ¸›å°‘ã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ãƒ“ãƒ¼ãƒ—ï¼ˆå°ã•ã‚ï¼‰
          if (secLeft < lastShownSec) playTick();
          lastShownSec = secLeft;
          setTimeLeftSec(secLeft);
          setSegsOn(secLeft);
        }
        if (left <= 0) timeUp();
      }, 50);
    }

    function flash(cardEl, good){
      cardEl.classList.remove("flashGood","flashBad");
      void cardEl.offsetWidth;
      cardEl.classList.add(good ? "flashGood" : "flashBad");
    }

    function nextQuestion(){
      lockedNext = false;
      stopRecognition();

      if (idx >= TOTAL){ finish(); return; }

      current = genQuestion();
      idx += 1;

      qMath.textContent = `${current.a} Ã— ${current.b}`;
      qYomi.textContent = current.chant;

      updatePills();
      setScreen("quiz");
      setMascot(rand(FACES), "<b>ã„ãã‚ˆï¼</b> 5ã³ã‚‡ã† ã„ãªã„ã« ã“ãŸãˆã¦ã­ã€‚", "ï¼ˆã“ãˆã§ ã“ãŸãˆã‚‹ï¼‰");

      speakQuestion(current);
      startTimer();

      lastTranscript = "";
      updatePills();

      if (recognitionOK){
        setTimeout(()=>{ if (running && !lockedNext) startRecognition(); }, 260);
      }
    }

    function lockAndAdvance(delayMs=260){
      lockedNext = true;
      stopRecognition();
      if (tickTimer) clearInterval(tickTimer);
      setTimeout(()=>{ if (running) nextQuestion(); }, delayMs);
    }

    function timeUp(){
      if (lockedNext) return;
      lastTranscript = "ï¼ˆã˜ã‹ã‚“ãã‚Œï¼‰";
      updatePills();
      setMascot("â±ï¸", "<b>ã˜ã‹ã‚“ãã‚Œï¼</b>", "ã¤ã ã„ã“ã†ï¼");
      flash($("quizCard"), false);
ping();
      lockAndAdvance(520);
    }

    function handleAnswer(transcript){
      if (lockedNext) return;

      lastTranscript = transcript;
      updatePills();

      const n = parseNumberJapanese(transcript);
      const ok = (n !== null && current && n === current.ans);

      if (ok){
        score += 1;
        updatePills();
        setMascot(rand(FACES), "<b>ã´ã‚“ã½ã‚“ï¼</b> ã„ã„ã­ï¼", "ã¤ã ã„ã“ã†ï¼");
        flash($("quizCard"), true);
        playCorrect();
lockAndAdvance(520);
      } else {
        setMascot("ğŸ˜µâ€ğŸ’«", "<b>ã¶ãƒ¼ï¼</b> ã¤ãã§ ã¨ã‚Šã‹ãˆãã†ï¼", "ã„ã¾ã® ã›ã„ã‹ã„ã‚’ ãã„ã¦ã­");
        flash($("quizCard"), false);
        playWrong();
lockAndAdvance(700);
      }
    }

    function finish(){
      running = false;
      stopRecognition();
      if (tickTimer) clearInterval(tickTimer);

      setScreen("result");
      resultScore.textContent = `ã›ã„ã‹ã„ ${score} / ${TOTAL}`;

      let msg = "ã¾ãŸ ã‚„ã£ã¦ã¿ã‚ˆã†ï¼";
      if (score === TOTAL) msg = "ãœã‚“ã¶ ã›ã„ã‹ã„ï¼ ã™ã”ã„ï¼";
      else if (score >= Math.floor(TOTAL*0.8)) msg = "ã‹ãªã‚Š ã§ããŸï¼ ã„ã„ã­ï¼";
      else if (score >= Math.floor(TOTAL*0.5)) msg = "ã„ã„ ã¡ã‚‡ã†ã—ï¼ ã¤ã¥ã‘ã‚ˆã†ï¼";
      else msg = "ã ã„ã˜ã‚‡ã†ã¶ã€‚ãã‚Šã‹ãˆã—ã§ ãŠã¼ãˆã‚‹ã‚ˆï¼";

      resultMsg.textContent = msg;
      setMascot(rand(FACES), "<b>ãŠã¤ã‹ã‚Œã•ã¾ï¼</b>", msg);

      pillState.textContent = "ãŠã‚ã‚Š";
      setTimeLeftSec(0);
      setSegsOn(0);
      speak(`ãŠã¤ã‹ã‚Œã•ã¾ã€‚ã›ã„ã‹ã„ã¯ ${score}ã€‚`, {rate:1.03, pitch:1.03});
    }

    function resetUI(){
      running = false;
      idx = 0;
      score = 0;
      current = null;
      lastTranscript = "";
      lockedNext = false;
      stopRecognition();
      if (tickTimer) clearInterval(tickTimer);

      updatePills();
      pillState.textContent = "ã¾ã„ã ã¾ã¡";
      setTimeLeftSec(LIMIT_SEC);
      setSegsOn(LIMIT_SEC);

      setScreen("intro");
      setMascot("ğŸ¤–", "<b>ãƒ«ãƒ¼ãƒ«</b>ï¼šã‚‚ã‚“ã ã„ãŒã§ãŸã‚‰ 5ã³ã‚‡ã† ã„ãªã„ã« ã“ãŸãˆã¦ã­ã€‚", "ï¼ˆãƒã‚¤ã‚¯ã‚’ã¤ã‹ã†ã‚ˆã€‚ã¯ã˜ã‚ã«ã€Œã‚¹ã‚¿ãƒ¼ãƒˆã€ã‚’ãŠã—ã¦ã­ï¼‰");
    }

    function startSession(){
      if (running) return;
      running = true;
      idx = 0;
      score = 0;
      lastTranscript = "";
      lockedNext = false;

      ping();
      ensureAudioCtx();

      updatePills();
      pillState.textContent = recognitionOK ? "ã¾ã„ã ãã‚‡ã‹" : "ã¾ã„ã NG";

      if (!recognitionOK){
        fallbackInfo.classList.remove("hidden");
        fallbackQuiz.classList.remove("hidden");
        setMascot("ğŸ˜µâ€ğŸ’«", "<b>éŸ³å£°å›ç­”ãŒ ã¤ã‹ãˆãªã„ã¿ãŸã„â€¦</b>", "ãƒ†ã‚¹ãƒˆç”¨ã« ã‚¿ãƒƒãƒ—ã§ ã“ãŸãˆã‚ˆã†");
      } else {
        fallbackInfo.classList.add("hidden");
        fallbackQuiz.classList.add("hidden");
        setMascot(rand(FACES), "<b>ã‚¹ã‚¿ãƒ¼ãƒˆï¼</b> ã„ãã‚ˆï¼", "ãƒã‚¤ã‚¯ã‚’ ãã‚‡ã‹ã—ã¦ã­");
        speak("ã‚¹ã‚¿ãƒ¼ãƒˆã€‚ãƒã‚¤ã‚¯ã‚’ ãã‚‡ã‹ã—ã¦ã­ã€‚", {rate:1.10, pitch:1.08});
      }

      setTimeout(()=>{ if (running) nextQuestion(); }, 480);
    }

    function stopSession(){
      running = false;
      stopRecognition();
      if (tickTimer) clearInterval(tickTimer);
      pillState.textContent = "ã¨ã‚ãŸ";
      setMascot("ğŸ›‘", "<b>ã¨ã‚ãŸã‚ˆã€‚</b>", "ã¾ãŸ ã‚¹ã‚¿ãƒ¼ãƒˆã§ ã•ã„ã—ã‚‡ã‹ã‚‰");
      setScreen("intro");
      setTimeLeftSec(LIMIT_SEC);
      setSegsOn(LIMIT_SEC);
    }

    function renderKeypad(container){
      const nums = [0,1,2,3,4,5,6,7,8,9];
      container.innerHTML = "";
      for (const n of nums){
        const b = document.createElement("button");
        b.className = "btn";
        b.textContent = String(n);
        b.addEventListener("click", ()=>{
          if (!running || lockedNext || !current) return;
          handleAnswer(String(n));
        });
        container.appendChild(b);
      }
    }
    renderKeypad(kbdIntro);
    renderKeypad(kbdQuiz);

    startBtn.addEventListener("click", startSession);
    stopBtn.addEventListener("click", stopSession);
    resetBtn.addEventListener("click", resetUI);

    soundBtn.addEventListener("click", ()=>{
      ensureAudioCtx();
      playTick();
      setTimeout(()=>playCorrect(), 120);
      setMascot(rand(FACES), "<b>ãŠã¨ ãƒ†ã‚¹ãƒˆï¼</b>", "ãã“ãˆãŸï¼Ÿ");
    });

    againBtn.addEventListener("click", ()=>{ resetUI(); startSession(); });
    backBtn.addEventListener("click", resetUI);

    setupRecognition();
    resetUI();
    updatePills();

    if (!recognitionOK){
      fallbackInfo.classList.remove("hidden");
      fallbackQuiz.classList.remove("hidden");
      pillState.textContent = "ã¾ã„ã NG";
    }
  </script>
</body>
</html>
