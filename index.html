<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>ä¹ä¹ã‚’éŸ³ã§ãŠã¼ãˆã‚‹</title>
  <style>
    :root{
      --bg:#0b1220;
      --card: rgba(255,255,255,.06);
      --line: rgba(255,255,255,.12);
      --text:#e8eefc;
      --muted:#a8b3d4;
      --accent:#7dd3fc;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --r: 22px;
      --red1:#fb7185;
      --red2:#f43f5e;
    }
    *{ box-sizing:border-box; }
    html, body { height: 100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Sans", "Noto Sans JP", sans-serif;
      color:var(--text);
      background:
        radial-gradient(1000px 700px at 20% 10%, rgba(125,211,252,.18), transparent 60%),
        radial-gradient(900px 650px at 80% 25%, rgba(134,239,172,.12), transparent 55%),
        radial-gradient(900px 650px at 40% 90%, rgba(252,165,165,.10), transparent 55%),
        var(--bg);
      overflow:hidden;
    }
    .app{
      height: 100%;
      max-width: 900px;
      margin: 0 auto;
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }
    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      user-select:none;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }
    .logo{
      width:40px;height:40px;border-radius:14px;
      background: linear-gradient(135deg, rgba(125,211,252,.95), rgba(134,239,172,.85));
      box-shadow: var(--shadow);
      flex: 0 0 auto;
    }
    .brandText{ display:flex; flex-direction:column; line-height:1.05; min-width:0; }
    .brandText b{
      font-size: 16px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brandText span{
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .btn{
      appearance:none;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 16px;
      padding: 10px 12px;
      font-weight: 900;
      cursor:pointer;
      box-shadow: 0 8px 18px rgba(0,0,0,.22);
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(125,211,252,.28), rgba(134,239,172,.18));
      border-color: rgba(125,211,252,.30);
    }
    .btn.ghost{ background: rgba(255,255,255,.05); }
    .btn.danger{
      background: linear-gradient(135deg, rgba(251,113,133,.35), rgba(244,63,94,.22));
      border-color: rgba(244,63,94,.45);
      color: #fff;
    }
    .btn.sel{
      outline: 2px solid rgba(125,211,252,.45);
      border-color: rgba(125,211,252,.45);
      background: rgba(125,211,252,.10);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--muted);
      font-size: 12px;
      font-weight: 800;
      white-space:nowrap;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding: 14px;
    }

    .main{
      flex: 1;
      display:flex;
      flex-direction:column;
      gap: 12px;
      min-height: 0;
    }

    .topRow{
      display:flex;
      gap: 12px;
      align-items:stretch;
      flex-wrap:wrap;
    }
    .topRow .card{ flex:1; min-width: 260px; }

    .mascot{
      display:flex;
      gap: 12px;
      align-items:center;
    }
    .face{
      width:64px;height:64px;border-radius:22px;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.25), transparent 35%),
                  linear-gradient(135deg, rgba(125,211,252,.9), rgba(167,139,250,.55));
      display:flex;align-items:center;justify-content:center;
      font-size: 36px;
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
      position:relative;
      overflow:hidden;
      flex: 0 0 auto;
    }
    .face::after{
      content:"";
      position:absolute; inset:-40%;
      background: linear-gradient(120deg, transparent, rgba(255,255,255,.16), transparent);
      transform: rotate(20deg);
      animation: shine 7s linear infinite;
    }
    @keyframes shine{
      0%{transform: translateX(-40%) rotate(20deg)}
      100%{transform: translateX(140%) rotate(20deg)}
    }
    .bubble{
      flex: 1;
      background: rgba(15, 23, 42, .65);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      padding: 10px 12px;
      min-height: 56px;
      line-height: 1.35;
      position:relative;
    }
    .bubble::before{
      content:"";
      position:absolute;
      left:-10px; top:18px;
      width:18px; height:18px;
      background: rgba(15, 23, 42, .65);
      border-left: 1px solid rgba(255,255,255,.12);
      border-bottom: 1px solid rgba(255,255,255,.12);
      transform: rotate(45deg);
    }
    .bubble b{ color: var(--accent); }

    .quiz{
      flex:1;
      display:flex;
      flex-direction:column;
      gap: 12px;
      min-height: 0;
    }
    .screen{
      flex: 1;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      text-align:center;
      gap: 10px;
      min-height: 0;
    }
    .qMath{
      font-size: clamp(44px, 7vw, 72px);
      font-weight: 1000;
      letter-spacing: .5px;
    }
    .qYomi{
      font-size: clamp(18px, 3.5vw, 28px);
      font-weight: 900;
      color: var(--accent);
    }
    .qSub{
      color: var(--muted);
      font-size: 13px;
      font-weight: 800;
      margin-top: 2px;
      line-height: 1.5;
    }

    /* 5-seg countdown */
    .segmeter{
      width: min(620px, 100%);
      display:flex;
      gap: 8px;
      align-items:center;
      justify-content:center;
      margin-top: 6px;
    }
    .seg{
      flex: 1 1 0;
      height: 16px;
      border-radius: 10px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      overflow:hidden;
      position:relative;
    }
    .seg.on::before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, rgba(125,211,252,.9), rgba(134,239,172,.9));
    }

    .bottomRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      flex-wrap:wrap;
    }
    .statusLine{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .flashGood{ animation: flashGood .28s ease; }
    .flashBad{ animation: flashBad .28s ease; }
    @keyframes flashGood{
      0%{ box-shadow: var(--shadow); border-color: rgba(134,239,172,.3); }
      40%{ box-shadow: 0 0 0 4px rgba(134,239,172,.18), var(--shadow); border-color: rgba(134,239,172,.55); }
      100%{ box-shadow: var(--shadow); border-color: var(--line); }
    }
    @keyframes flashBad{
      0%{ box-shadow: var(--shadow); border-color: rgba(252,165,165,.3); }
      40%{ box-shadow: 0 0 0 4px rgba(252,165,165,.18), var(--shadow); border-color: rgba(252,165,165,.55); }
      100%{ box-shadow: var(--shadow); border-color: var(--line); }
    }

    .hidden{ display:none !important; }

    /* mode-based visibility (no scroll on start screen) */
    body[data-mode="start"] .hideOnStart{ display:none !important; }
    body[data-mode="start"] .quiz.card{ padding: 12px; }
    body[data-mode="start"] .panel{ gap: 10px; }
    body[data-mode="start"] .courseRow{ padding: 10px; gap: 6px; }
    body[data-mode="start"] .panel h2{ font-size: 17px; }
    body[data-mode="start"] .note{ font-size: 11px; }
    body[data-mode="start"] .choiceBtn{ padding: 9px 10px; min-width: 44px; }
    @media (max-height: 720px){
      body[data-mode="start"] .note{ display:none; }
    }


    /* start screen */
    .panel{
      width: min(720px, 100%);
      text-align:left;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }
    .panel h2{
      margin:0;
      font-size: 18px;
      font-weight: 1000;
      letter-spacing: .2px;
    }
    .courseRow{
      display:flex;
      flex-direction:column;
      gap: 8px;
      padding: 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
    }
    .courseTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight: 1000;
    }
    .courseTitle span{
      color: var(--muted);
      font-weight: 900;
      font-size: 12px;
    }
    .choices{
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
    }
    .choicesGrid{
      display:grid;
      grid-template-columns: repeat(6, minmax(0,1fr));
      gap: 8px;
    }
    .choicesGrid .choiceBtn{ width:100%; min-width: 0; }
    .choicesGridRand{
      display:grid;
      grid-template-columns: repeat(5, minmax(0,1fr));
      gap: 8px;
    }
    .choicesGridRand .choiceBtn{ width:100%; min-width: 0; }
    .choiceBtn{
      padding: 10px 12px;
      border-radius: 14px;
      min-width: 46px;
      text-align:center;
      font-size: 15px;
    }
    .span2{ grid-column: span 2; }
    .star{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width: 24px;
      height: 24px;
      border-radius: 8px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      margin-left: 6px;
      font-size: 14px;
    }
    .note{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.45;
    }

    .fallback{
      display:flex;
      flex-direction:column;
      gap: 10px;
      width: min(620px, 100%);
      margin-top: 8px;
    }
    .kbd{
      display:grid;
      grid-template-columns: repeat(5, minmax(0,1fr));
      gap: 8px;
    }
    .kbd .btn{
      padding: 12px 10px;
      border-radius: 14px;
      font-size: 18px;
    }
  </style>
</head>

<body data-mode="start">
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="brandText">
          <b>ä¹ä¹ã‚’éŸ³ã§ãŠã¼ãˆã‚‹</b>
          <span>ã‚‚ã‚“ã ã„ã¯ ã¿ã‚‹ï¼‹ããï½œã“ãŸãˆã¯ ã“ãˆã§</span>
        </div>
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button class="btn ghost" id="soundBtn" title="ãŠã¨ãƒ†ã‚¹ãƒˆ">â™ª</button>
        <button class="btn" id="resetBtn" title="ã‚¹ã‚¿ãƒ¼ãƒˆãŒã‚ã‚“ã¸">â†º</button>
      </div>
    </header>

    <div class="main">
      <div class="topRow hideOnStart">
        <div class="card">
          <div class="mascot">
            <div class="face" id="face" aria-hidden="true">ğŸ¤–</div>
            <div class="bubble">
              <div id="bubbleMain"><b>ã‚²ãƒ¼ãƒ ã‚’ãˆã‚‰ã‚“ã§ã­ã€‚</b></div>
              <div id="bubbleSub" class="qSub" style="margin-top:6px;">ï¼ˆãƒã‚¤ã‚¯ã‚’ã¤ã‹ã†ã‚ˆã€‚ã¯ã˜ã‚ã‚‹ ã‚’ãŠã—ã¦ã­ï¼‰</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="statusLine">
            <span class="pill" id="pillCourse">ã‚³ãƒ¼ã‚¹ï¼šâ€”</span>
            <span class="pill" id="pillQ">ã‚‚ã‚“ã ã„ 0/0</span>
            <span class="pill" id="pillScore">ã›ã„ã‹ã„ 0</span>
            <span class="pill" id="pillState">ã¾ã„ã ã¾ã¡</span>
          </div>
          <div class="qSub" style="margin-top:10px;">
            ãƒ»1ã‚‚ã‚“ 5ã³ã‚‡ã†ï¼ˆã³ã‚‡ã†ã”ã¨ã« ãƒ”ãƒƒï¼‰<br/>
            ãƒ»ã›ã„ã‹ã„ï¼šãƒ”ãƒ³ãƒãƒ³ãƒ”ãƒ³ãƒãƒ¼ãƒ³ / ã¾ã¡ãŒã„ï¼šãƒ–ãƒƒãƒ–ãƒ¼
          </div>
          <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn" id="stopBtn">ã¨ã‚ã‚‹</button>
          </div>
        </div>
      </div>

      <div class="quiz card" id="quizCard">
        <!-- Start Screen -->
        <div class="screen" id="screenStart">
          <div class="panel">
            <h2>ã‚²ãƒ¼ãƒ ã›ã‚“ãŸã</h2>

            <div class="courseRow" id="rowAsc">
              <div class="courseTitle">
                <div>ã®ã¼ã‚Šä¹ä¹</div>
                <span>1â†’9 ã®ã˜ã‚…ã‚“ã°ã‚“</span>
              </div>
              <div class="choices choicesGrid" id="ascChoices"></div>
              <div class="note">â€»ï¼ˆâ­ï¼‰ã‚’ãˆã‚‰ã¶ã¨ã€ã ã‚“ãŒ ã‚‰ã‚“ã ã‚€ï¼ˆ1ã€œ9ï¼‰ã§ã§ã‚‹ã‚ˆ</div>
            </div>

            <div class="courseRow" id="rowDesc">
              <div class="courseTitle">
                <div>ãã ã‚Šä¹ä¹</div>
                <span>9â†’1 ã®ã˜ã‚…ã‚“ã°ã‚“</span>
              </div>
              <div class="choices choicesGrid" id="descChoices"></div>
              <div class="note">â€»ï¼ˆâ­ï¼‰ã‚’ãˆã‚‰ã¶ã¨ã€ã ã‚“ãŒ ã‚‰ã‚“ã ã‚€ï¼ˆ1ã€œ9ï¼‰ã§ã§ã‚‹ã‚ˆ</div>
            </div>

            <div class="courseRow" id="rowRand">
              <div class="courseTitle">
                <div>ã°ã‚‰ã°ã‚‰ä¹ä¹</div>
                <span>ã ã‚“ã¯ ã‹ã‚“ã‘ã„ãªã ã‚‰ã‚“ã ã‚€</span>
              </div>
              <div class="choices choicesGridRand" id="randChoices"></div>
              <div class="note">10=10ã‚‚ã‚“ / 20=20ã‚‚ã‚“ / 30=30ã‚‚ã‚“ / 40=40ã‚‚ã‚“ / 50=50ã‚‚ã‚“</div>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end; margin-top:6px;">
              <button class="btn danger" id="beginBtn" style="min-width: 160px;">ã¯ã˜ã‚ã‚‹</button>
            </div>
          </div>
        </div>

        <!-- Quiz Screen -->
        <div class="screen hidden" id="screenQuiz">
          <div class="qMath" id="qMath">2 Ã— 1</div>
          <div class="qYomi" id="qYomi">ã«ã„ã¡ãŒ</div>
          <div class="qSub">ã“ãŸãˆã‚’ ã“ãˆã§ ã„ã£ã¦ã­</div>

          <div class="segmeter" aria-label="countdown">
            <div class="seg on" id="seg1"></div>
            <div class="seg on" id="seg2"></div>
            <div class="seg on" id="seg3"></div>
            <div class="seg on" id="seg4"></div>
            <div class="seg on" id="seg5"></div>
          </div>

          <div class="fallback hidden" id="fallbackQuiz">
            <div class="kbd" id="kbdQuiz"></div>
            <div class="note">ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼šã‚¿ãƒƒãƒ—ã§ã‚‚OKï¼‰</div>
          </div>
        </div>

        <!-- Result Screen -->
        <div class="screen hidden" id="screenResult">
          <div class="qMath">ãŠã¤ã‹ã‚Œã•ã¾ï¼</div>
          <div class="qYomi" id="resultScore">ã›ã„ã‹ã„ 0 / 0</div>
          <div class="qSub" id="resultMsg">ã¾ãŸ ã‚„ã£ã¦ã¿ã‚ˆã†ï¼</div>
          <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
            <button class="btn primary" id="againBtn">ã‚‚ã†ã„ã¡ã©</button>
            <button class="btn" id="backBtn">ã‚¹ã‚¿ãƒ¼ãƒˆã¸</button>
          </div>
        </div>
      </div>

      <div class="bottomRow hideOnStart">
        <div class="statusLine">
          <span class="pill" id="pillLast">ã•ã„ã”ï¼šâ€”</span>
          <span class="pill" id="pillTime">ã®ã“ã‚Š 5s</span>
        </div>
        <div class="qSub">â€»ã¯ã˜ã‚ã¦ã¯ ãƒã‚¤ã‚¯ã® ãã‚‡ã‹ãŒ ã²ã¤ã‚ˆã†ã§ã™</div>
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    const face = $("face");
    const bubbleMain = $("bubbleMain");
    const bubbleSub = $("bubbleSub");

    const pillCourse = $("pillCourse");
    const pillQ = $("pillQ");
    const pillScore = $("pillScore");
    const pillState = $("pillState");
    const pillLast = $("pillLast");
    const pillTime = $("pillTime");

    const soundBtn = $("soundBtn");
    const resetBtn = $("resetBtn");
    const stopBtn = $("stopBtn");

    const screenStart = $("screenStart");
    const screenQuiz = $("screenQuiz");
    const screenResult = $("screenResult");

    const ascChoices = $("ascChoices");
    const descChoices = $("descChoices");
    const randChoices = $("randChoices");
    const beginBtn = $("beginBtn");

    const qMath = $("qMath");
    const qYomi = $("qYomi");
    const segEls = [$("seg1"),$("seg2"),$("seg3"),$("seg4"),$("seg5")];

    const fallbackQuiz = $("fallbackQuiz");
    const kbdQuiz = $("kbdQuiz");

    const resultScore = $("resultScore");
    const resultMsg = $("resultMsg");
    const againBtn = $("againBtn");
    const backBtn = $("backBtn");

    // -------- KUKU readings --------
    const KUKU = {
      1:{1:{chant:"ã„ã‚“ã„ã¡ãŒ",answerYomi:"ã„ã¡",ans:1},2:{chant:"ã„ã‚“ã«ãŒ",answerYomi:"ã«",ans:2},3:{chant:"ã„ã‚“ã•ã‚“ãŒ",answerYomi:"ã•ã‚“",ans:3},4:{chant:"ã„ã‚“ã—ãŒ",answerYomi:"ã—",ans:4},5:{chant:"ã„ã‚“ã”ãŒ",answerYomi:"ã”",ans:5},6:{chant:"ã„ã‚“ã‚ããŒ",answerYomi:"ã‚ã",ans:6},7:{chant:"ã„ã‚“ã—ã¡ãŒ",answerYomi:"ã—ã¡",ans:7},8:{chant:"ã„ã‚“ã¯ã¡ãŒ",answerYomi:"ã¯ã¡",ans:8},9:{chant:"ã„ã‚“ããŒ",answerYomi:"ã",ans:9}},
      2:{1:{chant:"ã«ã„ã¡ãŒ",answerYomi:"ã«",ans:2},2:{chant:"ã«ã«ã‚“ãŒ",answerYomi:"ã—",ans:4},3:{chant:"ã«ã•ã‚“ãŒ",answerYomi:"ã‚ã",ans:6},4:{chant:"ã«ã—ãŒ",answerYomi:"ã¯ã¡",ans:8},5:{chant:"ã«ã”",answerYomi:"ã˜ã‚…ã†",ans:10},6:{chant:"ã«ã‚ã",answerYomi:"ã˜ã‚…ã†ã«",ans:12},7:{chant:"ã«ã—ã¡",answerYomi:"ã˜ã‚…ã†ã—",ans:14},8:{chant:"ã«ã¯ã¡",answerYomi:"ã˜ã‚…ã†ã‚ã",ans:16},9:{chant:"ã«ã",answerYomi:"ã˜ã‚…ã†ã¯ã¡",ans:18}},
      3:{1:{chant:"ã•ã‚“ã„ã¡ãŒ",answerYomi:"ã•ã‚“",ans:3},2:{chant:"ã•ã‚“ã«ãŒ",answerYomi:"ã‚ã",ans:6},3:{chant:"ã•ã–ã‚“ãŒ",answerYomi:"ã",ans:9},4:{chant:"ã•ã‚“ã—",answerYomi:"ã˜ã‚…ã†ã«",ans:12},5:{chant:"ã•ã‚“ã”",answerYomi:"ã˜ã‚…ã†ã”",ans:15},6:{chant:"ã•ã¶ã‚ã",answerYomi:"ã˜ã‚…ã†ã¯ã¡",ans:18},7:{chant:"ã•ã‚“ã—ã¡",answerYomi:"ã«ã˜ã‚…ã†ã„ã¡",ans:21},8:{chant:"ã•ã‚“ã±",answerYomi:"ã«ã˜ã‚…ã†ã—",ans:24},9:{chant:"ã•ã‚“ã",answerYomi:"ã«ã˜ã‚…ã†ã—ã¡",ans:27}},
      4:{1:{chant:"ã—ã„ã¡ãŒ",answerYomi:"ã—",ans:4},2:{chant:"ã—ã«ãŒ",answerYomi:"ã¯ã¡",ans:8},3:{chant:"ã—ã•ã‚“",answerYomi:"ã˜ã‚…ã†ã«",ans:12},4:{chant:"ã—ã—",answerYomi:"ã˜ã‚…ã†ã‚ã",ans:16},5:{chant:"ã—ã”",answerYomi:"ã«ã˜ã‚…ã†",ans:20},6:{chant:"ã—ã‚ã",answerYomi:"ã«ã˜ã‚…ã†ã—",ans:24},7:{chant:"ã—ã—ã¡",answerYomi:"ã«ã˜ã‚…ã†ã¯ã¡",ans:28},8:{chant:"ã—ã¯",answerYomi:"ã•ã‚“ã˜ã‚…ã†ã«",ans:32},9:{chant:"ã—ã",answerYomi:"ã•ã‚“ã˜ã‚…ã†ã‚ã",ans:36}},
      5:{1:{chant:"ã”ã„ã¡ãŒ",answerYomi:"ã”",ans:5},2:{chant:"ã”ã«",answerYomi:"ã˜ã‚…ã†",ans:10},3:{chant:"ã”ã•ã‚“",answerYomi:"ã˜ã‚…ã†ã”",ans:15},4:{chant:"ã”ã—",answerYomi:"ã«ã˜ã‚…ã†",ans:20},5:{chant:"ã”ã”",answerYomi:"ã«ã˜ã‚…ã†ã”",ans:25},6:{chant:"ã”ã‚ã",answerYomi:"ã•ã‚“ã˜ã‚…ã†",ans:30},7:{chant:"ã”ã—ã¡",answerYomi:"ã•ã‚“ã˜ã‚…ã†ã”",ans:35},8:{chant:"ã”ã¯",answerYomi:"ã—ã˜ã‚…ã†",ans:40},9:{chant:"ã”ã£ã",answerYomi:"ã—ã˜ã‚…ã†ã”",ans:45}},
      6:{1:{chant:"ã‚ãã„ã¡ãŒ",answerYomi:"ã‚ã",ans:6},2:{chant:"ã‚ãã«",answerYomi:"ã˜ã‚…ã†ã«",ans:12},3:{chant:"ã‚ãã•ã‚“",answerYomi:"ã˜ã‚…ã†ã¯ã¡",ans:18},4:{chant:"ã‚ãã—",answerYomi:"ã«ã˜ã‚…ã†ã—",ans:24},5:{chant:"ã‚ãã”",answerYomi:"ã•ã‚“ã˜ã‚…ã†",ans:30},6:{chant:"ã‚ãã‚ã",answerYomi:"ã•ã‚“ã˜ã‚…ã†ã‚ã",ans:36},7:{chant:"ã‚ãã—ã¡",answerYomi:"ã—ã˜ã‚…ã†ã«",ans:42},8:{chant:"ã‚ãã¯",answerYomi:"ã—ã˜ã‚…ã†ã¯ã¡",ans:48},9:{chant:"ã‚ã£ã",answerYomi:"ã”ã˜ã‚…ã†ã—",ans:54}},
      7:{1:{chant:"ã—ã¡ã„ã¡ãŒ",answerYomi:"ã—ã¡",ans:7},2:{chant:"ã—ã¡ã«",answerYomi:"ã˜ã‚…ã†ã—",ans:14},3:{chant:"ã—ã¡ã•ã‚“",answerYomi:"ã«ã˜ã‚…ã†ã„ã¡",ans:21},4:{chant:"ã—ã¡ã—",answerYomi:"ã«ã˜ã‚…ã†ã¯ã¡",ans:28},5:{chant:"ã—ã¡ã”",answerYomi:"ã•ã‚“ã˜ã‚…ã†ã”",ans:35},6:{chant:"ã—ã¡ã‚ã",answerYomi:"ã—ã˜ã‚…ã†ã«",ans:42},7:{chant:"ã—ã¡ã—ã¡",answerYomi:"ã—ã˜ã‚…ã†ã",ans:49},8:{chant:"ã—ã¡ã¯",answerYomi:"ã”ã˜ã‚…ã†ã‚ã",ans:56},9:{chant:"ã—ã¡ã",answerYomi:"ã‚ãã˜ã‚…ã†ã•ã‚“",ans:63}},
      8:{1:{chant:"ã¯ã¡ã„ã¡ãŒ",answerYomi:"ã¯ã¡",ans:8},2:{chant:"ã¯ã¡ã«",answerYomi:"ã˜ã‚…ã†ã‚ã",ans:16},3:{chant:"ã¯ã¡ã•ã‚“",answerYomi:"ã«ã˜ã‚…ã†ã—",ans:24},4:{chant:"ã¯ã¡ã—",answerYomi:"ã•ã‚“ã˜ã‚…ã†ã«",ans:32},5:{chant:"ã¯ã¡ã”",answerYomi:"ã—ã˜ã‚…ã†",ans:40},6:{chant:"ã¯ã¡ã‚ã",answerYomi:"ã—ã˜ã‚…ã†ã¯ã¡",ans:48},7:{chant:"ã¯ã¡ã—ã¡",answerYomi:"ã”ã˜ã‚…ã†ã‚ã",ans:56},8:{chant:"ã¯ã£ã±",answerYomi:"ã‚ãã˜ã‚…ã†ã—",ans:64},9:{chant:"ã¯ã£ã",answerYomi:"ã—ã¡ã˜ã‚…ã†ã«",ans:72}},
      9:{1:{chant:"ãã„ã¡ãŒ",answerYomi:"ã",ans:9},2:{chant:"ãã«",answerYomi:"ã˜ã‚…ã†ã¯ã¡",ans:18},3:{chant:"ãã•ã‚“",answerYomi:"ã«ã˜ã‚…ã†ã—ã¡",ans:27},4:{chant:"ãã—",answerYomi:"ã•ã‚“ã˜ã‚…ã†ã‚ã",ans:36},5:{chant:"ãã”",answerYomi:"ã—ã˜ã‚…ã†ã”",ans:45},6:{chant:"ãã‚ã",answerYomi:"ã”ã˜ã‚…ã†ã—",ans:54},7:{chant:"ãã—ã¡",answerYomi:"ã‚ãã˜ã‚…ã†ã•ã‚“",ans:63},8:{chant:"ãã¯",answerYomi:"ã—ã¡ã˜ã‚…ã†ã«",ans:72},9:{chant:"ãã",answerYomi:"ã¯ã¡ã˜ã‚…ã†ã„ã¡",ans:81}}
    };

    // -------- TTS --------
    function speak(text, {rate=1.18, pitch=1.06, volume=1.0} = {}){
      if (!("speechSynthesis" in window) || !("SpeechSynthesisUtterance" in window)) return false;
      try{
        const u = new SpeechSynthesisUtterance(text);
        u.lang = "ja-JP";
        u.rate = rate;
        u.pitch = pitch;
        u.volume = volume;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(u);
        return true;
      }catch{
        return false;
      }
    }

    // -------- SFX (WebAudio) --------
    let audioCtx = null;
    function ensureAudioCtx(){
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === "suspended") audioCtx.resume().catch(()=>{});
      return audioCtx;
    }

    function playTone(freq, duration, {volume=0.12, type="sine", attack=0.008, release=0.03} = {}){
      if (!(window.AudioContext || window.webkitAudioContext)) return;
      try{
        const ctx = ensureAudioCtx();
        const now = ctx.currentTime;

        const g = ctx.createGain();
        g.gain.setValueAtTime(0.0001, now);
        g.gain.linearRampToValueAtTime(volume, now + attack);
        g.gain.setTargetAtTime(0.0001, now + duration, release);
        g.connect(ctx.destination);

        const o = ctx.createOscillator();
        o.type = type;
        o.frequency.setValueAtTime(freq, now);
        o.connect(g);
        o.start(now);
        o.stop(now + duration + 0.08);
      }catch{}
    }

    function playTick(){
      playTone(1100, 0.05, {volume:0.04, type:"square", attack:0.002, release:0.02});
    }

    function playCorrect(){
      if (!(window.AudioContext || window.webkitAudioContext)) return;
      try{
        const ctx = ensureAudioCtx();
        const now = ctx.currentTime;

        const g = ctx.createGain();
        g.gain.setValueAtTime(0.0001, now);
        g.gain.linearRampToValueAtTime(0.14, now + 0.01);
        g.gain.setTargetAtTime(0.0001, now + 0.55, 0.06);
        g.connect(ctx.destination);

        const o = ctx.createOscillator();
        o.type = "sine";
        o.connect(g);

        o.frequency.setValueAtTime(880, now);
        o.frequency.setValueAtTime(988, now + 0.12);
        o.frequency.setValueAtTime(784, now + 0.24);
        o.frequency.setValueAtTime(1046, now + 0.34);

        o.start(now);
        o.stop(now + 0.70);
      }catch{}
    }

    function playWrong(){
      if (!(window.AudioContext || window.webkitAudioContext)) return;
      try{
        const ctx = ensureAudioCtx();
        const now = ctx.currentTime;

        const g = ctx.createGain();
        g.gain.setValueAtTime(0.0001, now);
        g.gain.linearRampToValueAtTime(0.12, now + 0.01);
        g.gain.setTargetAtTime(0.0001, now + 0.42, 0.08);
        g.connect(ctx.destination);

        const o = ctx.createOscillator();
        o.type = "sawtooth";
        o.frequency.setValueAtTime(180, now);
        o.frequency.linearRampToValueAtTime(140, now + 0.12);
        o.frequency.setValueAtTime(160, now + 0.20);
        o.frequency.linearRampToValueAtTime(150, now + 0.42);

        o.connect(g);
        o.start(now);
        o.stop(now + 0.55);
      }catch{}
    }

    // -------- SpeechRecognition --------
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let rec = null;
    let recognitionOK = !!SpeechRecognition;

    function setupRecognition(){
      if (!recognitionOK) return;
      rec = new SpeechRecognition();
      rec.lang = "ja-JP";
      rec.interimResults = false;
      rec.maxAlternatives = 3;
      rec.continuous = false;

      rec.onstart = () => { pillState.textContent = "ã¾ã„ã ON"; };
      rec.onend = () => { pillState.textContent = running ? "ã¾ã„ã ãã„ã¦ã‚‹â€¦" : "ã¾ã„ã OFF"; };
      rec.onerror = () => {
        pillState.textContent = "ã¾ã„ã NG";
        setMascot("ğŸ˜µâ€ğŸ’«", "<b>ãƒã‚¤ã‚¯ãŒ ã¤ã‹ãˆãªã„ã¿ãŸã„â€¦</b>", "ãã‚‡ã‹ï¼ˆè¨±å¯ï¼‰ã‚’ ã‹ãã«ã‚“ã—ã¦ã­");
      };
      rec.onresult = (ev) => {
        if (!running || lockedNext) return;
        const res = ev.results?.[0];
        if (!res) return;
        const transcript = String(res[0].transcript || "").trim();
        handleAnswer(transcript);
      };
    }

    // -------- answer parsing --------
    const DIGIT_MAP = {"ãœã‚":0,"ã‚Œã„":0,"0":0,"ã€‡":0,"é›¶":0,"ã„ã¡":1,"1":1,"ä¸€":1,"ã«":2,"2":2,"äºŒ":2,"ã•ã‚“":3,"3":3,"ä¸‰":3,"ã—":4,"ã‚ˆã‚“":4,"4":4,"å››":4,"ã”":5,"5":5,"äº”":5,"ã‚ã":6,"6":6,"å…­":6,"ãªãª":7,"ã—ã¡":7,"7":7,"ä¸ƒ":7,"ã¯ã¡":8,"8":8,"å…«":8,"ãã‚…ã†":9,"ã":9,"9":9,"ä¹":9};
    function normalizeKana(s){ return String(s||"").toLowerCase().replace(/\s+/g,"").replace(/ãƒ¼/g,"").replace(/[ï¼Œ,ã€‚ï¼.ï¼!ï¼Ÿ?]/g,""); }
    function parseNumberJapanese(input){
      const raw = normalizeKana(input);
      if (!raw) return null;
      const m = raw.match(/(\d{1,3})/);
      if (m){ const v = Number(m[1]); return Number.isFinite(v)? v : null; }
      if (raw in DIGIT_MAP) return DIGIT_MAP[raw];

      const tensWords = [
        {k:["ã˜ã‚…ã†","å"], v:10},
        {k:["ã«ã˜ã‚…ã†","äºŒå"], v:20},
        {k:["ã•ã‚“ã˜ã‚…ã†","ä¸‰å"], v:30},
        {k:["ã‚ˆã‚“ã˜ã‚…ã†","ã—ã˜ã‚…ã†","å››å"], v:40},
        {k:["ã”ã˜ã‚…ã†","äº”å"], v:50},
        {k:["ã‚ãã˜ã‚…ã†","å…­å"], v:60},
        {k:["ãªãªã˜ã‚…ã†","ã—ã¡ã˜ã‚…ã†","ä¸ƒå"], v:70},
        {k:["ã¯ã¡ã˜ã‚…ã†","å…«å"], v:80},
        {k:["ãã‚…ã†ã˜ã‚…ã†","ãã˜ã‚…ã†","ä¹å"], v:90},
      ];
      for (const t of tensWords){
        for (const kk of t.k){
          if (raw === kk) return t.v;
          if (raw.startsWith(kk)){
            const rest = raw.slice(kk.length);
            if (!rest) return t.v;
            if (rest in DIGIT_MAP) return t.v + DIGIT_MAP[rest];
          }
        }
      }
      return null;
    }

    // -------- game state --------
    const LIMIT_MS = 5000;
    const LIMIT_SEC = 5;

    let running = false;
    let idx = 0;
    let score = 0;
    let current = null;

    let tickTimer = null;
    let tStart = 0;
    let lastTranscript = "";
    let lockedNext = false;
    let lastShownSec = 5;

    let questionPool = [];
    let totalQuestions = 0;

    const FACES = ["ğŸ¤–","ğŸ¦Š","ğŸ¸","ğŸ¼","ğŸ¦‰","ğŸ™","ğŸ§ ","ğŸš€"];
    function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    function setMascot(emoji, main, sub){
      face.textContent = emoji;
      bubbleMain.innerHTML = main;
      bubbleSub.textContent = sub || "";
    }

    function setScreen(which){
      document.body.setAttribute("data-mode", which);
      screenStart.classList.toggle("hidden", which !== "start");
      screenQuiz.classList.toggle("hidden", which !== "quiz");
      screenResult.classList.toggle("hidden", which !== "result");
    }

    function updatePills(){
      pillQ.textContent = `ã‚‚ã‚“ã ã„ ${Math.min(idx, totalQuestions)}/${totalQuestions}`;
      pillScore.textContent = `ã›ã„ã‹ã„ ${score}`;
      pillLast.textContent = lastTranscript ? `ã•ã„ã”ï¼š${lastTranscript}` : "ã•ã„ã”ï¼šâ€”";
    }

    function setTimeLeftSec(sec){
      const s = Math.max(0, Math.min(LIMIT_SEC, sec));
      pillTime.textContent = `ã®ã“ã‚Š ${s}s`;
    }

    function setSegsOn(n){
      for (let i=0;i<segEls.length;i++){
        segEls[i].classList.toggle("on", i < n);
      }
    }

    function stopRecognition(){ try{ rec && rec.stop(); }catch{} }
    function startRecognition(){ if (!recognitionOK) return; try{ rec.start(); }catch{} }

    function speakQuestion(q){
      speak(`${q.chant}ã€‚`, {rate:1.20, pitch:1.06});
    }

    function startTimer(){
      tStart = performance.now();
      lastShownSec = LIMIT_SEC;
      setTimeLeftSec(LIMIT_SEC);
      setSegsOn(LIMIT_SEC);

      if (tickTimer) clearInterval(tickTimer);
      tickTimer = setInterval(()=>{
        if (!running || lockedNext) return;
        const now = performance.now();
        const elapsed = now - tStart;
        const left = LIMIT_MS - elapsed;

        const secLeft = Math.max(0, Math.ceil(left / 1000));
        if (secLeft !== lastShownSec){
          if (secLeft < lastShownSec) playTick();
          lastShownSec = secLeft;
          setTimeLeftSec(secLeft);
          setSegsOn(secLeft);
        }
        if (left <= 0) timeUp();
      }, 50);
    }

    function flash(cardEl, good){
      cardEl.classList.remove("flashGood","flashBad");
      void cardEl.offsetWidth;
      cardEl.classList.add(good ? "flashGood" : "flashBad");
    }

    function timeUp(){
      if (lockedNext) return;
      lastTranscript = "ï¼ˆã˜ã‹ã‚“ãã‚Œï¼‰";
      updatePills();
      setMascot("â±ï¸", "<b>ã˜ã‹ã‚“ãã‚Œï¼</b>", "ã¤ã ã„ã“ã†ï¼");
      flash($("quizCard"), false);
      lockAndAdvance(260);
    }

    function nextQuestion(){
      lockedNext = false;
      stopRecognition();

      if (idx >= totalQuestions){
        finish();
        return;
      }

      current = questionPool[idx];
      idx += 1;

      qMath.textContent = `${current.a} Ã— ${current.b}`;
      qYomi.textContent = current.chant;

      updatePills();
      setScreen("quiz");
      setMascot(rand(FACES), "<b>ã„ãã‚ˆï¼</b> 5ã³ã‚‡ã† ã„ãªã„ã« ã“ãŸãˆã¦ã­ã€‚", "");

      speakQuestion(current);
      startTimer();

      lastTranscript = "";
      updatePills();

      if (recognitionOK){
        setTimeout(()=>{ if (running && !lockedNext) startRecognition(); }, 260);
      }
    }

    function lockAndAdvance(delayMs=260){
      lockedNext = true;
      stopRecognition();
      if (tickTimer) clearInterval(tickTimer);
      setTimeout(()=>{ if (running) nextQuestion(); }, delayMs);
    }

    function handleAnswer(transcript){
      if (lockedNext) return;
      lastTranscript = transcript;
      updatePills();

      const n = parseNumberJapanese(transcript);
      const ok = (n !== null && current && n === current.ans);

      if (ok){
        score += 1;
        updatePills();
        setMascot(rand(FACES), "<b>ã›ã„ã‹ã„ï¼</b>", "");
        flash($("quizCard"), true);
        playCorrect();
        lockAndAdvance(300);
      } else {
        setMascot("ğŸ˜µâ€ğŸ’«", "<b>ã¾ã¡ãŒã„ï¼</b>", "");
        flash($("quizCard"), false);
        playWrong();
        lockAndAdvance(360);
      }
    }

    function finish(){
      running = false;
      stopRecognition();
      if (tickTimer) clearInterval(tickTimer);

      setScreen("result");
      resultScore.textContent = `ã›ã„ã‹ã„ ${score} / ${totalQuestions}`;

      let msg = "ã¾ãŸ ã‚„ã£ã¦ã¿ã‚ˆã†ï¼";
      if (score === totalQuestions) msg = "ãœã‚“ã¶ ã›ã„ã‹ã„ï¼ ã™ã”ã„ï¼";
      else if (score >= Math.floor(totalQuestions*0.8)) msg = "ã‹ãªã‚Š ã§ããŸï¼ ã„ã„ã­ï¼";
      else if (score >= Math.floor(totalQuestions*0.5)) msg = "ã„ã„ ã¡ã‚‡ã†ã—ï¼ ã¤ã¥ã‘ã‚ˆã†ï¼";
      else msg = "ã ã„ã˜ã‚‡ã†ã¶ã€‚ãã‚Šã‹ãˆã—ã§ ãŠã¼ãˆã‚‹ã‚ˆï¼";

      resultMsg.textContent = msg;
      setMascot(rand(FACES), "<b>ãŠã¤ã‹ã‚Œã•ã¾ï¼</b>", msg);

      pillState.textContent = "ãŠã‚ã‚Š";
      setTimeLeftSec(0);
      setSegsOn(0);
    }

    // -------- course selection --------
    const COURSE = { ASC: "asc", DESC: "desc", RAND: "rand" };

    let selectedCourse = COURSE.RAND;
    let selectedDan = "rand";     
    let selectedRandCount = 10;   

    function labelCourse(){
      if (selectedCourse === COURSE.ASC) return `ã®ã¼ã‚Šä¹ä¹ï¼š${selectedDan === "rand" ? "â€»" : selectedDan}`;
      if (selectedCourse === COURSE.DESC) return `ãã ã‚Šä¹ä¹ï¼š${selectedDan === "rand" ? "â€»" : selectedDan}`;
      return `ã°ã‚‰ã°ã‚‰ä¹ä¹ï¼š${selectedRandCount}`;
    }

    function setCourse(course){ selectedCourse = course; updateCourseUI(); }
    function setDan(d){ selectedDan = d; updateCourseUI(); }
    function setRandCount(n){ selectedRandCount = n; updateCourseUI(); }

    function clearSel(container){
      [...container.querySelectorAll("button")].forEach(b=>b.classList.remove("sel"));
    }

    function updateCourseUI(){
      clearSel(ascChoices);
      clearSel(descChoices);
      clearSel(randChoices);

      if (selectedCourse === COURSE.ASC){
        const btn = $(`asc-${selectedDan}`);
        if (btn) btn.classList.add("sel");
      } else if (selectedCourse === COURSE.DESC){
        const btn = $(`desc-${selectedDan}`);
        if (btn) btn.classList.add("sel");
      } else {
        const btn = $(`rand-${selectedRandCount}`);
        if (btn) btn.classList.add("sel");
      }

      pillCourse.textContent = `ã‚³ãƒ¼ã‚¹ï¼š${labelCourse()}`;
    }

    function shuffle(arr){
      for (let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]] = [arr[j],arr[i]];
      }
      return arr;
    }

    function makePoolForAscDesc(isAsc, danPick){
      const dans = (danPick === "rand") ? [1,2,3,4,5,6,7,8,9] : [Number(danPick)];
      const bs = isAsc ? [1,2,3,4,5,6,7,8,9] : [9,8,7,6,5,4,3,2,1];

      const pool = [];
      for (const a of dans){
        for (const b of bs){
          const it = KUKU[a][b];
          pool.push({a,b, chant: it.chant, answerYomi: it.answerYomi, ans: it.ans});
        }
      }
      if (danPick === "rand") shuffle(pool);
      return pool;
    }

    function makePoolForRandom(count){
      const all = [];
      for (let a=1;a<=9;a++){
        for (let b=1;b<=9;b++){
          const it = KUKU[a][b];
          all.push({a,b, chant: it.chant, answerYomi: it.answerYomi, ans: it.ans});
        }
      }
      shuffle(all);
      return all.slice(0, count);
    }

    function buildPoolFromSelection(){
      if (selectedCourse === COURSE.ASC){
        questionPool = makePoolForAscDesc(true, selectedDan);
      } else if (selectedCourse === COURSE.DESC){
        questionPool = makePoolForAscDesc(false, selectedDan);
      } else {
        questionPool = makePoolForRandom(selectedRandCount);
      }
      totalQuestions = questionPool.length;
    }

    function resetToStart(){
      running = false;
      idx = 0;
      score = 0;
      current = null;
      lastTranscript = "";
      lockedNext = false;

      stopRecognition();
      if (tickTimer) clearInterval(tickTimer);

      setTimeLeftSec(LIMIT_SEC);
      setSegsOn(LIMIT_SEC);

      pillState.textContent = recognitionOK ? "ã¾ã„ã ã¾ã¡" : "ã¾ã„ã NG";
      setMascot("ğŸ¤–", "<b>ã‚²ãƒ¼ãƒ ã‚’ãˆã‚‰ã‚“ã§ã­ã€‚</b>", "ï¼ˆãƒã‚¤ã‚¯ã‚’ã¤ã‹ã†ã‚ˆã€‚ã¯ã˜ã‚ã‚‹ ã‚’ãŠã—ã¦ã­ï¼‰");
      setScreen("start");

      buildPoolFromSelection();
      updatePills();
      updateCourseUI();

      if (!recognitionOK){
        fallbackQuiz.classList.remove("hidden");
      } else {
        fallbackQuiz.classList.add("hidden");
      }
    }

    function startSession(){
      if (running) return;

      ensureAudioCtx();
      buildPoolFromSelection();

      running = true;
      idx = 0;
      score = 0;
      lastTranscript = "";
      lockedNext = false;

      updatePills();
      pillState.textContent = recognitionOK ? "ã¾ã„ã ãã‚‡ã‹" : "ã¾ã„ã NG";

      if (!recognitionOK){
        fallbackQuiz.classList.remove("hidden");
        setMascot("ğŸ˜µâ€ğŸ’«", "<b>éŸ³å£°ã«ã‚“ã—ããŒ ã¤ã‹ãˆãªã„â€¦</b>", "ãƒ†ã‚¹ãƒˆã‚ˆã†ã« ã‚¿ãƒƒãƒ—ã§ ã“ãŸãˆã‚ˆã†");
      } else {
        fallbackQuiz.classList.add("hidden");
        setMascot(rand(FACES), "<b>ã‚¹ã‚¿ãƒ¼ãƒˆï¼</b>", "");
      }

      setTimeout(()=>{ if (running) nextQuestion(); }, 350);
    }

    function stopSession(){
      running = false;
      stopRecognition();
      if (tickTimer) clearInterval(tickTimer);
      pillState.textContent = "ã¨ã‚ãŸ";
      resetToStart();
    }

    // -------- keypad fallback (test only) --------
    function renderKeypad(container){
      const nums = [0,1,2,3,4,5,6,7,8,9];
      container.innerHTML = "";
      for (const n of nums){
        const b = document.createElement("button");
        b.className = "btn";
        b.textContent = String(n);
        b.addEventListener("click", ()=>{
          if (!running || lockedNext || !current) return;
          handleAnswer(String(n));
        });
        container.appendChild(b);
      }
    }
    renderKeypad(kbdQuiz);

    // -------- build course UI buttons --------
    function makeChoiceButton(id, text, onClick){
      const b = document.createElement("button");
      b.id = id;
      b.className = "btn choiceBtn";
      b.textContent = text;
      b.addEventListener("click", onClick);
      return b;
    }

    function buildDanChoices(container, prefix, course){
      container.innerHTML = "";
      for (let i=1;i<=9;i++){
        container.appendChild(makeChoiceButton(`${prefix}-${i}`, String(i), ()=>{
          setCourse(course);
          setDan(String(i));
        }));
      }
      const starBtn = document.createElement("button");
      starBtn.id = `${prefix}-rand`;
      starBtn.className = "btn choiceBtn span2";
      starBtn.innerHTML = 'â€» <span class="star">â­</span>';
      starBtn.addEventListener("click", ()=>{
        setCourse(course);
        setDan("rand");
      });
      container.appendChild(starBtn);
    }

    function buildRandChoices(container){
      container.innerHTML = "";
      [10,20,30,40,50].forEach(n=>{
        container.appendChild(makeChoiceButton(`rand-${n}`, String(n), ()=>{
          setCourse(COURSE.RAND);
          setRandCount(n);
        }));
      });
    }

    buildDanChoices(ascChoices, "asc", COURSE.ASC);
    buildDanChoices(descChoices, "desc", COURSE.DESC);
    buildRandChoices(randChoices);

    // -------- events --------
    beginBtn.addEventListener("click", ()=>{
      ensureAudioCtx();
      startSession();
    });

    stopBtn.addEventListener("click", stopSession);
    resetBtn.addEventListener("click", resetToStart);

    soundBtn.addEventListener("click", ()=>{
      ensureAudioCtx();
      playTick();
      setTimeout(()=>playCorrect(), 120);
      setMascot(rand(FACES), "<b>ãŠã¨ ãƒ†ã‚¹ãƒˆï¼</b>", "ãã“ãˆãŸï¼Ÿ");
    });

    againBtn.addEventListener("click", ()=>{ resetToStart(); startSession(); });
    backBtn.addEventListener("click", resetToStart);

    // -------- init --------
    setupRecognition();
    setCourse(COURSE.RAND);
    setRandCount(10);
    resetToStart();
  </script>
</body>
</html>
