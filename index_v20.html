<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ã‚¯ãƒƒã‚¯å…ˆç”Ÿã®ä¹ä¹ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° v20</title>
  <style>
    :root{
      --bg1:#0b1220; --bg2:#1a2a3a;
      --glass: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.14);
      --text:#f3f6ff; --muted:rgba(243,246,255,.72);
      --red1: rgba(239,68,68,.86);
      --red2: rgba(245,158,11,.22);
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --r: 26px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,
        "Noto Sans JP","Hiragino Kaku Gothic ProN","Meiryo",sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(56,189,248,.20), transparent 60%),
        radial-gradient(900px 700px at 80% 0%, rgba(34,197,94,.12), transparent 55%),
        radial-gradient(900px 700px at 50% 110%, rgba(244,63,94,.12), transparent 55%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      overflow:hidden;
    }
    .wrap{
      height:100%;
      max-width: 520px;
      margin:0 auto;
      padding: 14px 14px 18px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    header{
      display:flex; align-items:center; justify-content:space-between;
      padding: 10px 12px;
      border-radius: 18px;
      background: linear-gradient(135deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
    }
    .brand{display:flex; gap:10px; align-items:center; min-width:0;}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: radial-gradient(circle at 30% 30%, rgba(56,189,248,.85), rgba(34,197,94,.65));
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 12px 30px rgba(0,0,0,.22);
      flex:0 0 auto;
    }
    .title{display:flex; flex-direction:column; min-width:0;}
    .title b{font-size:18px; line-height:1.05; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .title span{font-size:12px; color:var(--muted); margin-top:3px}
    .iconBtns{display:flex; gap:10px}
    .iconBtn{
      width:46px;height:46px;border-radius:16px;
      background: rgba(255,255,255,.08);
      border: 1px solid var(--stroke);
      display:grid;place-items:center;
      box-shadow: 0 10px 26px rgba(0,0,0,.22);
      user-select:none;
    }
    .iconBtn:active{transform: translateY(1px)}
    .iconBtn svg{opacity:.92}

    .card{
      flex:1;
      border-radius: var(--r);
      background: linear-gradient(160deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      overflow:hidden;
    }
    .screen{display:none; height:100%}
    .screen.on{display:flex; flex-direction:column; gap:12px; height:100%}

    .bigGrid{display:flex; flex-direction:column; gap:12px; padding: 4px 2px;}
    .bigBtn{
      width:100%;
      padding: 22px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: linear-gradient(135deg, var(--red1), var(--red2));
      box-shadow: 0 18px 60px rgba(239,68,68,.18);
      color: white;
      font-weight: 900;
      font-size: 28px;
      letter-spacing: .06em;
      user-select:none;
    }
    .bigBtn:active{transform: translateY(1px)}
    .subRow{display:flex; gap:10px; align-items:center; justify-content:space-between}
    .pill{
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.07);
      border: 1px solid var(--stroke);
      color: var(--muted);
      font-size: 12px;
      display:flex; align-items:center; gap:8px;
    }
    .micDot{
      width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,.35);
      box-shadow: 0 0 0 2px rgba(255,255,255,.08);
    }
    .micDot.on{background: rgba(34,197,94,.85)}
    .micDot.off{background: rgba(239,68,68,.85)}
    .micDot.wait{background: rgba(245,158,11,.9)}

    .tiles{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
    }
    .tile{
      padding: 14px 0;
      border-radius: 18px;
      background: rgba(255,255,255,.07);
      border: 1px solid var(--stroke);
      color: var(--text);
      font-weight: 900;
      font-size: 18px;
      text-align:center;
      user-select:none;
    }
    .tile:active{transform: translateY(1px)}
    .tile.on{
      outline: 3px solid rgba(56,189,248,.40);
      background: rgba(56,189,248,.18);
      border-color: rgba(56,189,248,.28);
    }
    .tile.star{font-size:18px}
    .tile.star small{display:block; font-size:10px; color:rgba(255,255,255,.80); margin-top:3px; font-weight:800; letter-spacing:.02em}
    .actions{
      margin-top:auto;
      display:flex; gap:12px; align-items:center; justify-content:space-between;
    }
    .ghostBtn{
      flex:1;
      padding: 16px 14px;
      border-radius: 22px;
      background: rgba(255,255,255,.07);
      border: 1px solid var(--stroke);
      color: var(--text);
      font-weight: 900;
      font-size: 16px;
      user-select:none;
      display:flex; align-items:center; justify-content:center; gap:10px;
    }
    .ghostBtn:active{transform: translateY(1px)}
    .playBtn{
      flex:1.25;
      padding: 16px 14px;
      border-radius: 22px;
      background: linear-gradient(135deg, rgba(239,68,68,.92), rgba(245,158,11,.18));
      border: 1px solid rgba(239,68,68,.42);
      color: #fff;
      font-weight: 1000;
      font-size: 16px;
      user-select:none;
      display:flex; align-items:center; justify-content:center; gap:10px;
      box-shadow: 0 18px 60px rgba(239,68,68,.16);
    }
    .playBtn:active{transform: translateY(1px)}

    .mascotRow{display:flex; gap:12px; align-items:center}
    .mascot{
      width:58px;height:58px;border-radius: 18px;
      background: rgba(255,255,255,.08);
      border: 1px solid var(--stroke);
      display:grid; place-items:center;
      font-size: 28px;
      box-shadow: 0 14px 34px rgba(0,0,0,.22);
      flex:0 0 auto;
    }
    .bubble{
      flex:1;
      border-radius: 18px;
      background: rgba(255,255,255,.07);
      border: 1px solid var(--stroke);
      padding: 10px 12px;
      color: var(--muted);
      line-height: 1.25;
      font-size: 13px;
      min-height: 58px;
      display:flex; align-items:center;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .qBox{
      border-radius: var(--r);
      background: rgba(0,0,0,.10);
      border: 1px solid rgba(255,255,255,.10);
      padding: 14px;
      display:flex; flex-direction:column; gap:10px;
    }
    .qMath{
      font-size: 44px;
      font-weight: 1000;
      letter-spacing: .03em;
      text-align:center;
    }
    .qYomi{
      font-size: 22px;
      font-weight: 1000;
      text-align:center;
      color: rgba(255,255,255,.88);
      letter-spacing: .06em;
    }
    .meterRow{display:flex; align-items:center; justify-content:center}
    .ticks{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      width: 220px;
      max-width: 72vw;
    }
    .tick{
      height: 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.16);
      border: 1px solid rgba(255,255,255,.12);
    }
    .tick.off{opacity:.20}

    .micMeterWrap{
      display:flex; align-items:center; justify-content:center;
      margin-top: 2px;
    }
    .micMeter{
      width: 220px;
      max-width: 72vw;
      height: 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      overflow:hidden;
      box-shadow: 0 10px 24px rgba(0,0,0,.14);
    }
    .micFill{
      height:100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(34,197,94,.55), rgba(56,189,248,.55), rgba(239,68,68,.55));
      transition: width 60ms linear;
    }

    .okng{
      display:flex; gap:10px; align-items:center; justify-content:center;
      margin-top: 6px;
    }
    .iconCircle{
      width:44px;height:44px;border-radius: 16px;
      background: rgba(255,255,255,.07);
      border: 1px solid var(--stroke);
      display:grid;place-items:center;
      font-size: 22px;
      box-shadow: 0 12px 30px rgba(0,0,0,.18);
      user-select:none;
    }
    .countText{
      font-weight: 1000;
      font-size: 18px;
      color: rgba(255,255,255,.86);
      min-width: 64px;
      text-align:center;
    }
    .playStop{
      position: absolute;
      right: 18px;
      top: 82px;
      width: 56px;height:56px;border-radius: 18px;
      background: rgba(255,255,255,.09);
      border: 1px solid var(--stroke);
      box-shadow: 0 16px 46px rgba(0,0,0,.28);
      display:grid;place-items:center;
      user-select:none;
      z-index: 5;
    }
    .playStop:active{transform: translateY(1px)}
    .hint{ text-align:center; color: var(--muted); font-size: 12px; margin-top: 4px; }

    .resultTitle{
      font-weight: 1000;
      font-size: 22px;
      text-align:center;
      margin-top: 6px;
    }
    .resultNums{
      display:flex; justify-content:space-between; gap:12px;
      margin-top: 10px;
    }
    .resultCard{
      flex:1;
      border-radius: 22px;
      background: rgba(255,255,255,.07);
      border: 1px solid var(--stroke);
      padding: 16px 12px;
      text-align:center;
      box-shadow: 0 14px 34px rgba(0,0,0,.18);
    }
    .resultCard b{display:block;font-size:34px;letter-spacing:.02em}
    .resultCard span{display:block;margin-top:4px;color:var(--muted);font-size:12px;font-weight:900;letter-spacing:.06em}
  
  .srRow{ display:flex; justify-content:center; margin-top:10px; }
.srLast{ margin-top:8px; text-align:center; font-size:12px; color:rgba(243,246,255,.70); min-height:16px; }
.srLast b{ color:rgba(243,246,255,.92); font-weight:700; }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <div class="title">
          <b>ã‚¯ãƒƒã‚¯å…ˆç”Ÿã®ä¹ä¹ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</b>
          <span>ãŒãã—ã‚…ã†ã˜ã‚ƒãªã„ã€‚ã‚²ãƒ¼ãƒ ã ã€‚</span>
        </div>
      </div>
      <div class="iconBtns">
        <div class="iconBtn" id="btnSound" title="ã‚µã‚¦ãƒ³ãƒ‰">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M11 5 6 9H3v6h3l5 4V5Z" stroke="white" stroke-width="2" stroke-linejoin="round"/><path d="M15.5 8.5a4 4 0 0 1 0 7" stroke="white" stroke-width="2" stroke-linecap="round"/><path d="M17.5 6a7 7 0 0 1 0 12" stroke="white" stroke-width="2" stroke-linecap="round" opacity=".7"/></svg>
        </div>
        <div class="iconBtn" id="btnReload" title="ãƒªãƒ­ãƒ¼ãƒ‰">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M21 12a9 9 0 1 1-3-6.7" stroke="white" stroke-width="2" stroke-linecap="round"/><path d="M21 4v6h-6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </div>
      </div>
    </header>

    <div class="card">
      <div class="screen on" id="screenCourse">
        <div class="bigGrid">
          <button class="bigBtn" id="courseUp">ã®ã¼ã‚Šä¹ä¹</button>
          <button class="bigBtn" id="courseDown">ãã ã‚Šä¹ä¹</button>
          <button class="bigBtn" id="courseRandom">ã°ã‚‰ã°ã‚‰ä¹ä¹</button>
        </div>
        <div class="subRow">
          <div class="pill">v20</div>
          <div class="pill" id="micPill"><span class="micDot wait" id="micDot"></span><span id="micTxt">ğŸ¤ ã˜ã‚…ã‚“ã³</span></div>
        </div>
      </div>

      <div class="screen" id="screenDan">
        <div class="mascotRow">
          <div class="mascot">ğŸ¤–</div>
          <div class="bubble">ã ã‚“ ã‚’ ãˆã‚‰ã‚“ã§ã­ï¼ˆâ˜…=ã°ã‚‰ã°ã‚‰ï¼‰</div>
        </div>
        <div class="tiles" id="danTiles"></div>
        <div class="actions">
          <button class="ghostBtn" id="backCourse1">ã‚‚ã©ã‚‹</button>
          <button class="playBtn" id="startFromDan"><span>â–¶</span><span>ã¯ã˜ã‚ã‚‹</span></button>
        </div>
      </div>

      <div class="screen" id="screenCount">
        <div class="mascotRow">
          <div class="mascot">ğŸ¤–</div>
          <div class="bubble">ã‚‚ã‚“ã™ã† ã‚’ ãˆã‚‰ã‚“ã§ã­</div>
        </div>
        <div class="tiles" id="countTiles"></div>
        <div class="actions">
          <button class="ghostBtn" id="backCourse2">ã‚‚ã©ã‚‹</button>
          <button class="playBtn" id="startFromCount"><span>â–¶</span><span>ã¯ã˜ã‚ã‚‹</span></button>
        </div>
      </div>

      <div class="screen" id="screenGame" style="position:relative;">
        <div class="playStop" id="playStopBtn" title="ã‚¹ã‚¿ãƒ¼ãƒˆ / ã¨ã‚ã‚‹"></div>

        <div class="mascotRow">
          <div class="mascot">ğŸ¤–</div>
          <div class="bubble" id="bubbleGame">ã„ãã‚ˆï¼</div>
        </div>

        <div class="qBox">
          <div class="qMath" id="qMath">- Ã— -</div>
          <div class="qYomi" id="qYomi">-</div>

          <div class="meterRow">
            <div class="ticks" id="ticks"></div>
          </div>

          <div class="micMeterWrap">
            <div class="micMeter" aria-label="ãƒã‚¤ã‚¯ã®ãƒ¡ãƒ¼ã‚¿ãƒ¼">
              <div class="micFill" id="micFill"></div>
            </div>
          </div>

          <div class="srRow">
            <div class="pill" id="micPillGame"><span class="micDot wait" id="micDotGame"></span><span id="micTxtGame">ğŸ¤ ã˜ã‚…ã‚“ã³</span></div>
          </div>

          <div class="srLast" id="srLast">ãã“ãˆãŸ: <b>-</b></div>

          <div class="okng">
            <div class="iconCircle" title="ã›ã„ã‹ã„">â­•</div>
            <div class="countText" id="okCount">0</div>
            <div class="iconCircle" title="ã¯ãšã‚Œ">âŒ</div>
            <div class="countText" id="ngCount">0</div>
          </div>

          <div class="hint" id="srHint">ã“ãˆã§ ã“ãŸãˆã¦ã­</div>
        </div>
      </div>

      <div class="screen" id="screenResult">
        <div class="mascotRow">
          <div class="mascot">ğŸ¤–</div>
          <div class="bubble" id="bubbleResult">ãŠã‚ã‚Šï¼</div>
        </div>

        <div class="qBox">
          <div class="resultTitle">ã‘ã£ã‹</div>
          <div class="resultNums">
            <div class="resultCard">
              <b id="resTotal">0</b>
              <span>ã‚‚ã‚“ã¡ã‚…ã†</span>
            </div>
            <div class="resultCard">
              <b id="resOk">0</b>
              <span>ã›ã„ã‹ã„</span>
            </div>
            <div class="resultCard">
              <b id="resNg">0</b>
              <span>ã¯ãšã‚Œ</span>
            </div>
          </div>

          <div class="actions" style="margin-top:16px;">
            <button class="ghostBtn" id="btnEnd">ãŠã‚ã‚‹</button>
            <button class="playBtn" id="btnRetry"><span>â†»</span><span>ã‚‚ã†1ã‹ã„ï¼</span></button>
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
(() => {
  "use strict";
  const $ = (sel, el=document) => el.querySelector(sel);

  const screenCourse = $("#screenCourse");
  const screenDan = $("#screenDan");
  const screenCount = $("#screenCount");
  const screenGame = $("#screenGame");
  const screenResult = $("#screenResult");

  const courseUpBtn = $("#courseUp");
  const courseDownBtn = $("#courseDown");
  const courseRandomBtn = $("#courseRandom");

  const danTiles = $("#danTiles");
  const countTiles = $("#countTiles");
  const backCourse1 = $("#backCourse1");
  const backCourse2 = $("#backCourse2");
  const startFromDan = $("#startFromDan");
  const startFromCount = $("#startFromCount");

  const playStopBtn = $("#playStopBtn");
  const qMath = $("#qMath");
  const qYomi = $("#qYomi");
  const ticksEl = $("#ticks");
  const okCountEl = $("#okCount");
  const ngCountEl = $("#ngCount");
  const bubbleGame = $("#bubbleGame");
  const srHint = $("#srHint");

  const micTxt = $("#micTxt");
  const micDot = $("#micDot");
  const micTxtGame = $("#micTxtGame");
  const micDotGame = $("#micDotGame");
  const micFill = $("#micFill");
  const srLast = $("#srLast");

  const btnSound = $("#btnSound");
  const btnReload = $("#btnReload");

  const resTotal = $("#resTotal");
  const resOk = $("#resOk");
  const resNg = $("#resNg");
  const btnRetry = $("#btnRetry");
  const btnEnd = $("#btnEnd");

  function setScreen(name){
    for (const el of [screenCourse, screenDan, screenCount, screenGame, screenResult]) el.classList.remove("on");
    if (name==="course") screenCourse.classList.add("on");
    if (name==="dan") screenDan.classList.add("on");
    if (name==="count") screenCount.classList.add("on");
    if (name==="game") screenGame.classList.add("on");
    if (name==="result") screenResult.classList.add("on");
  }

  // Audio (SFX)
  let audioCtx = null;
  let sfxOn = true;
  function ensureAudio(){
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === "suspended") audioCtx.resume().catch(()=>{});
  }
  function beep({freq=880, dur=0.06, vol=0.06, type="sine"}={}){
    if (!sfxOn) return;
    ensureAudio();
    const t0 = audioCtx.currentTime;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type;
    o.frequency.setValueAtTime(freq, t0);
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(Math.max(0.0001, vol), t0+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t0+dur);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(t0); o.stop(t0+dur+0.02);
  }
  function buzz(){
    if (!sfxOn) return;
    ensureAudio();
    const t0 = audioCtx.currentTime;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = "square";
    o.frequency.setValueAtTime(160, t0);
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(0.13, t0+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t0+0.42);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(t0); o.stop(t0+0.5);
  }
  function pingpong(){
    if (!sfxOn) return;
    const seq = [
      {f:880, d:0.08, v:0.13},
      {f:988, d:0.08, v:0.13},
      {f:784, d:0.18, v:0.12},
    ];
    let delay = 0;
    for (const s of seq){
      setTimeout(()=>beep({freq:s.f, dur:s.d, vol:s.v, type:"sine"}), delay);
      delay += Math.round((s.d+0.05)*1000);
    }
  }
  function applauseAndCheer(){
    if (!sfxOn) return;
    ensureAudio();
    const t0 = audioCtx.currentTime;

    const bufferSize = Math.floor(audioCtx.sampleRate * 0.9);
    const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i=0;i<bufferSize;i++){
      data[i] = (Math.random()*2-1) * (Math.random() < 0.5 ? 0.6 : 0.3);
    }
    const noise = audioCtx.createBufferSource();
    noise.buffer = buffer;
    const bp = audioCtx.createBiquadFilter();
    bp.type = "bandpass";
    bp.frequency.setValueAtTime(1600, t0);
    bp.Q.setValueAtTime(0.8, t0);
    const ng = audioCtx.createGain();
    ng.gain.setValueAtTime(0.0001, t0);
    ng.gain.exponentialRampToValueAtTime(0.18, t0+0.02);
    ng.gain.exponentialRampToValueAtTime(0.0001, t0+0.85);
    noise.connect(bp); bp.connect(ng); ng.connect(audioCtx.destination);
    noise.start(t0); noise.stop(t0+0.92);

    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = "triangle";
    o.frequency.setValueAtTime(340, t0);
    o.frequency.exponentialRampToValueAtTime(820, t0+0.65);
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(0.07, t0+0.05);
    g.gain.exponentialRampToValueAtTime(0.0001, t0+0.85);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(t0); o.stop(t0+0.9);
  }

  btnSound.addEventListener("click", ()=>{
    sfxOn = !sfxOn;
    ensureAudio();
    btnSound.style.opacity = sfxOn ? "1" : ".45";
  });
  btnReload.addEventListener("click", ()=>location.reload());

  // TTS
  function speakAsync(text, {rate=1.25, pitch=1.05, volume=1.0}={}){
    return new Promise((resolve)=>{
      if (!("speechSynthesis" in window) || !("SpeechSynthesisUtterance" in window)) return resolve(false);
      try{
        const u = new SpeechSynthesisUtterance(text);
        u.lang = "ja-JP";
        u.rate = rate; u.pitch = pitch; u.volume = volume;
        u.onend = ()=>resolve(true);
        u.onerror = ()=>resolve(false);
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(u);
      }catch{ resolve(false); }
    });
  }

  // Mic meter
  let micStream = null;
  let micAnalyser = null;
  let micData = null;
  let micRAF = 0;
  let micReady = false;

  async function ensureMic(){
    if (micReady) return true;
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
      micTxt.textContent = "ğŸ¤ Ã—";
      micDot.className = "micDot off";
      return false;
    }
    try{
      micStream = await navigator.mediaDevices.getUserMedia({
        audio: { echoCancellation:true, noiseSuppression:true, autoGainControl:true }
      });
      ensureAudio();
      const src = audioCtx.createMediaStreamSource(micStream);
      micAnalyser = audioCtx.createAnalyser();
      micAnalyser.fftSize = 1024;
      micData = new Uint8Array(micAnalyser.fftSize);
      src.connect(micAnalyser);
      micReady = true;
      return true;
    }catch{
      micReady = false;
      micTxt.textContent = "ğŸ¤ NG";
      micDot.className = "micDot off";
      micFill.style.width = "0%";
      return false;
    }
  }

  function startMicMeterLoop(){
    cancelAnimationFrame(micRAF);
    const loop = () => {
      if (!micReady || !micAnalyser){ micFill.style.width="0%"; return; }
      micAnalyser.getByteTimeDomainData(micData);
      let sum = 0;
      for (let i=0;i<micData.length;i++){
        const v = (micData[i]-128)/128;
        sum += v*v;
      }
      const rms = Math.sqrt(sum/micData.length);
      let pct = Math.min(100, Math.max(0, (rms * 220)));
      pct = Math.pow(pct/100, 0.6) * 100;
      micFill.style.width = pct.toFixed(1) + "%";
      micRAF = requestAnimationFrame(loop);
    };
    micRAF = requestAnimationFrame(loop);
  }

  function stopMicMeter(){
    cancelAnimationFrame(micRAF);
    micRAF = 0;
    try{
      if (micStream){
        micStream.getTracks().forEach(t=>{ try{t.stop();}catch{} });
      }
    }catch{}
    micStream = null;
    micAnalyser = null;
    micData = null;
    micReady = false;
    try{ micFill && (micFill.style.width="0%"); }catch{}
  }


  // KUKU yomi only (no answer leak)
  const yomiByA = {
    1: ["ã„ã‚“ã„ã¡ãŒ","ã„ã‚“ã«ãŒ","ã„ã‚“ã•ã‚“ãŒ","ã„ã‚“ã—ãŒ","ã„ã‚“ã”ãŒ","ã„ã‚“ã‚ããŒ","ã„ã‚“ã—ã¡ãŒ","ã„ã‚“ã¯ã¡ãŒ","ã„ã‚“ããŒ"],
    2: ["ã«ã„ã¡ãŒ","ã«ã«ã‚“ãŒ","ã«ã•ã‚“ãŒ","ã«ã—ãŒ","ã«ã”","ã«ã‚ã","ã«ã—ã¡","ã«ã¯ã¡","ã«ã"],
    3: ["ã•ã‚“ã„ã¡ãŒ","ã•ã‚“ã«ãŒ","ã•ã–ã‚“ãŒ","ã•ã‚“ã—","ã•ã‚“ã”","ã•ã¶ã‚ã","ã•ã‚“ã—ã¡","ã•ã‚“ã±","ã•ã‚“ã"],
    4: ["ã—ã„ã¡ãŒ","ã—ã«ãŒ","ã—ã•ã‚“","ã—ã—","ã—ã”","ã—ã‚ã","ã—ã—ã¡","ã—ã¯","ã—ã"],
    5: ["ã”ã„ã¡ãŒ","ã”ã«","ã”ã•ã‚“","ã”ã—","ã”ã”","ã”ã‚ã","ã”ã—ã¡","ã”ã¯","ã”ã£ã"],
    6: ["ã‚ãã„ã¡ãŒ","ã‚ãã«","ã‚ãã•ã‚“","ã‚ãã—","ã‚ãã”","ã‚ãã‚ã","ã‚ãã—ã¡","ã‚ãã¯","ã‚ã£ã"],
    7: ["ã—ã¡ã„ã¡ãŒ","ã—ã¡ã«","ã—ã¡ã•ã‚“","ã—ã¡ã—","ã—ã¡ã”","ã—ã¡ã‚ã","ã—ã¡ã—ã¡","ã—ã¡ã¯","ã—ã¡ã"],
    8: ["ã¯ã¡ã„ã¡ãŒ","ã¯ã¡ã«","ã¯ã¡ã•ã‚“","ã¯ã¡ã—","ã¯ã¡ã”","ã¯ã¡ã‚ã","ã¯ã¡ã—ã¡","ã¯ã£ã±","ã¯ã£ã"],
    9: ["ãã„ã¡ãŒ","ãã«","ãã•ã‚“","ãã—","ãã”","ãã‚ã","ãã—ã¡","ãã¯","ãã"],
  };
  const KUKU = [];
  for (let a=1;a<=9;a++){
    for (let b=1;b<=9;b++){
      KUKU.push({a,b,yomi:yomiByA[a][b-1], answer:a*b});
    }
  }

  // Selection state
  let selectedCourse = null; // up|down|random
  let selectedDans = new Set();
  let starOn = false;
  let selectedCount = 10;

  function buildDanTiles(){
    danTiles.innerHTML = "";
    for (let i=1;i<=9;i++){
      const btn = document.createElement("div");
      btn.className = "tile";
      btn.textContent = String(i);
      btn.dataset.dan = String(i);
      btn.addEventListener("click", ()=>{
        ensureAudio();
        if (selectedDans.has(i)) selectedDans.delete(i); else selectedDans.add(i);
        btn.classList.toggle("on", selectedDans.has(i));
      });
      danTiles.appendChild(btn);
    }
    const star = document.createElement("div");
    star.className = "tile star";
    star.innerHTML = "â˜…<small>ã°ã‚‰ã°ã‚‰</small>";
    star.addEventListener("click", ()=>{
      ensureAudio();
      starOn = !starOn;
      star.classList.toggle("on", starOn);
    });
    danTiles.appendChild(star);
  }

  function buildCountTiles(){
    countTiles.innerHTML = "";
    const counts = [10,20,30,40,50];
    for (const c of counts){
      const btn = document.createElement("div");
      btn.className = "tile";
      btn.textContent = String(c);
      btn.dataset.count = String(c);
      btn.addEventListener("click", ()=>{
        ensureAudio();
        selectedCount = c;
        for (const el of countTiles.querySelectorAll(".tile")) el.classList.remove("on");
        btn.classList.add("on");
      });
      countTiles.appendChild(btn);
    }
    const first = countTiles.querySelector('.tile[data-count="10"]');
    if (first) first.classList.add("on");
  }

  buildDanTiles();
  buildCountTiles();

  // Game state
  const LIMIT_MS = 5000;
  let running = false;
  let paused = true;
  let locked = false;
  let tStart = 0;
  let tickTimer = null;
  let tickInterval = null;
  let ok = 0, ng = 0;
  let pool = [];
  let idx = 0;
  let current = null;

  function initTicks(){
    ticksEl.innerHTML = "";
    for (let i=0;i<5;i++){
      const d = document.createElement("div");
      d.className = "tick";
      ticksEl.appendChild(d);
    }
  }
  initTicks();
  function setTicks(secLeft){
    const ticks = [...ticksEl.children];
    for (let i=0;i<5;i++){
      ticks[i].classList.toggle("off", !(i < secLeft));
    }
  }
  function updateScore(){
    okCountEl.textContent = String(ok);
    ngCountEl.textContent = String(ng);
  }
  function stopTimers(){
    if (tickTimer){ clearTimeout(tickTimer); tickTimer = null; }
    if (tickInterval){ clearInterval(tickInterval); tickInterval = null; }
  }

  // SpeechRecognition (v20: keep it alive; restart aggressively)
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  const hasSR = !!SR;
  let rec = null;
  let recActive = false;   // we want SR running (game/resume)
  let recRunning = false;  // SR engine says "onstart"
  let lastStart = 0;
  let restartTimer = null;
  let lastError = "";

  function setSRState(state){ // idle|listening|wait|off|err
    const apply = (txtEl, dotEl, text, dotCls) => {
      if (!txtEl || !dotEl) return;
      txtEl.textContent = text;
      dotEl.className = "micDot " + dotCls;
    };
    if (!hasSR){
      apply(micTxt, micDot, "ğŸ¤ Ã— (SRãªã—)", "off");
      apply(micTxtGame, micDotGame, "ğŸ¤ Ã—", "off");
      srHint.textContent = "ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ãŒä½¿ãˆãªã„ã‚ˆ";
      return;
    }
    if (state==="listening"){
      apply(micTxt, micDot, "ğŸ¤ ãã„ã¦ã‚‹", "on");
      apply(micTxtGame, micDotGame, "ğŸ¤ ãã„ã¦ã‚‹", "on");
      srHint.textContent = "ã“ãˆã§ ã“ãŸãˆã¦ã­";
    } else if (state==="wait"){
      apply(micTxt, micDot, "ğŸ¤ ã•ã„ãã©ã†â€¦", "wait");
      apply(micTxtGame, micDotGame, "ğŸ¤ ã•ã„ãã©ã†â€¦", "wait");
      srHint.textContent = "ï¼ˆã¾ã£ã¦ã­ï¼‰";
    } else if (state==="idle"){
      apply(micTxt, micDot, "ğŸ¤ ã˜ã‚…ã‚“ã³", "wait");
      apply(micTxtGame, micDotGame, "ğŸ¤ ã˜ã‚…ã‚“ã³", "wait");
    } else if (state==="off"){
      apply(micTxt, micDot, "ğŸ¤ ã¨ã¾ã£ã¦ã‚‹", "off");
      apply(micTxtGame, micDotGame, "ğŸ¤ ã¨ã¾ã£ã¦ã‚‹", "off");
    } else if (state==="err"){
      apply(micTxt, micDot, "ğŸ¤ NG", "off");
      apply(micTxtGame, micDotGame, "ğŸ¤ NG", "off");
      srHint.textContent = lastError ? ("éŸ³å£°NG: " + lastError) : "éŸ³å£°NG";
    }
  }

  function setupRecognition(){
    if (!hasSR) { setSRState("off"); return; }
    rec = new SR();
    rec.lang = "ja-JP";
    rec.interimResults = true;   // short utterance pickup
    rec.maxAlternatives = 5;
    // NOTE: Android Chrome sometimes ignores continuous; we keep restarting onend anyway.
    rec.continuous = true;

    rec.onstart = () => {
      recRunning = true;
      setSRState("listening");
    };
    rec.onend = () => {
      recRunning = false;
      if (recActive) scheduleRestart();
      else setSRState("off");
    };
    rec.onerror = (e) => {
      recRunning = false;
      lastError = e && e.error ? e.error : "error";
      // 'no-speech' ã¯ã‚ˆãå‡ºã‚‹ã®ã§å³ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ
      if (recActive) scheduleRestart(true);
      else setSRState("err");
    };
    rec.onresult = (ev) => {
      if (!running || paused || locked) return; // only during answer window
      // Collect latest hypotheses (final + interim). Android often provides short interim bursts.
      const alts = [];
      for (let r = ev.resultIndex; r < ev.results.length; r++){
        const res = ev.results[r];
        if (!res) continue;
        const nAlt = Math.min(res.length, 5);
        for (let i=0;i<nAlt;i++){
          const t = String(res[i].transcript||"").trim();
          if (t) alts.push(t);
        }
      }
      if (!alts.length) return;

      // Show what we heard (best-effort: first alternative of last result)
      const latest = alts[0];
      if (srLast){
        srLast.innerHTML = 'ãã“ãˆãŸ: <b>' + escapeHtml(latest) + '</b>';
      }

      const picked = pickBestAnswer(alts);
      if (picked == null) return;
      handleAnswer(picked);
    };
    setSRState("idle");
  }
  setupRecognition();

  function safeStartRec(){
    if (!hasSR || !rec) return;
    const now = performance.now();
    if (now - lastStart < 450) return;
    lastStart = now;
    try{
      rec.start();
    }catch{
      // start() can throw if already started; we just retry via schedule
      scheduleRestart();
    }
  }
  function safeStopRec(){
    if (!hasSR || !rec) return;
    try{ rec.stop(); }catch{}
  }
  function safeAbortRec(){
    if (!hasSR || !rec) return;
    try{ rec.abort && rec.abort(); }catch{}
  }
  function scheduleRestart(isError=false){
    if (!recActive) return;
    if (restartTimer) clearTimeout(restartTimer);
    setSRState(isError ? "err" : "wait");
    restartTimer = setTimeout(()=>{
      if (!recActive) return;
      // abort then start to clear stuck state
      try{ safeAbortRec(); }catch{}
      setTimeout(()=>{ if (recActive) safeStartRec(); }, 120);
    }, 180);
  }

  // Prime SR must be inside user gesture on Android.
  async function primeSRInGesture(){
    if (!hasSR || !rec) return;
    recActive = true;
    setSRState("wait");
    safeStartRec();
  }

  // Answer parsing
  const WORD = {
    "ã„ã¡":1,"ã„ã£":1,"ã²ã¨":1,
    "ã«":2,"ã•ã‚“":3,"ã—":4,"ã‚ˆã‚“":4,"ã”":5,"ã‚ã":6,"ã—ã¡":7,"ãªãª":7,"ã¯ã¡":8,"ã":9,"ãã‚…ã†":9,
    "ã˜ã‚…ã†":10,"ã˜ã‚…ã†ã„ã¡":11,"ã˜ã‚…ã†ã«":12,"ã˜ã‚…ã†ã•ã‚“":13,"ã˜ã‚…ã†ã—":14,"ã˜ã‚…ã†ã‚ˆã‚“":14,"ã˜ã‚…ã†ã”":15,"ã˜ã‚…ã†ã‚ã":16,
    "ã˜ã‚…ã†ã—ã¡":17,"ã˜ã‚…ã†ãªãª":17,"ã˜ã‚…ã†ã¯ã¡":18,"ã˜ã‚…ã†ã":19,"ã˜ã‚…ã†ãã‚…ã†":19,
    "ã«ã˜ã‚…ã†":20,"ã«ã˜ã‚…ã†ã„ã¡":21,"ã«ã˜ã‚…ã†ã«":22,"ã«ã˜ã‚…ã†ã•ã‚“":23,"ã«ã˜ã‚…ã†ã—":24,"ã«ã˜ã‚…ã†ã‚ˆã‚“":24,"ã«ã˜ã‚…ã†ã”":25,"ã«ã˜ã‚…ã†ã‚ã":26,"ã«ã˜ã‚…ã†ã—ã¡":27,
    "ã«ã˜ã‚…ã†ã¯ã¡":28,"ã«ã˜ã‚…ã†ã":29,"ã•ã‚“ã˜ã‚…ã†":30,"ã•ã‚“ã˜ã‚…ã†ã«":32,"ã•ã‚“ã˜ã‚…ã†ã”":35,"ã•ã‚“ã˜ã‚…ã†ã‚ã":36,
    "ã—ã˜ã‚…ã†":40,"ã—ã˜ã‚…ã†ã«":42,"ã—ã˜ã‚…ã†ã”":45,"ã—ã˜ã‚…ã†ã¯ã¡":48,"ã”ã˜ã‚…ã†":50,"ã”ã˜ã‚…ã†ã—":54,"ã”ã˜ã‚…ã†ã‚ˆã‚“":54,"ã”ã˜ã‚…ã†ã‚ã":56,
    "ã‚ãã˜ã‚…ã†ã•ã‚“":63,"ã‚ãã˜ã‚…ã†ã—":64,"ã—ã¡ã˜ã‚…ã†ã«":72,"ãªãªã˜ã‚…ã†ã«":72,"ã¯ã¡ã˜ã‚…ã†ã„ã¡":81
  };
  const ALIAS = {"ã¯ã£ã±":8,"ã¯ã£ã":72,"ã‚ã£ã":6,"ã”ã£ã":5,"ã•ã¶ã‚ã":18,"ã«ã":18,"ã•ã‚“ã":27,"ã—ã":36};
  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }
  function kataToHira(s){
    return String(s||"").replace(/[\u30A1-\u30F6]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0x60));
  }
  const KANJI_DIG = {"ã€‡":0,"é›¶":0,"ä¸€":1,"äºŒ":2,"ä¸‰":3,"å››":4,"äº”":5,"å…­":6,"ä¸ƒ":7,"å…«":8,"ä¹":9};
  function parseKanjiNumber(s){
    // Supports 0-99 for patterns like å, åå…«, äºŒå, äºŒåä¸‰...
    if (!s) return null;
    if (!/^[ã€‡é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+$/.test(s)) return null;
    if (s === "å") return 10;
    if (s.includes("å")){
      const [a,b] = s.split("å");
      const tens = a ? (KANJI_DIG[a] ?? null) : 1;
      const ones = b ? (KANJI_DIG[b] ?? null) : 0;
      if (tens==null || ones==null) return null;
      return tens*10 + ones;
    }
    // single digit
    return KANJI_DIG[s] ?? null;
  }
  function normalize(str){
    let s = (str||"").toString().trim();
    s = kataToHira(s);
    s = s.replace(/[\u3000\s]+/g,"");
    s = s.replace(/[ã€‚ï¼Œï¼,!?ï¼ï¼Ÿã€‚ã€]/g,"");
    s = s.replace(/ãƒ¼/g,"");      // long vowel mark
    s = s.replace(/ã£/g,"");      // small tsu (often appears in STT)
    s = s.toLowerCase();

    // Common STT confusions for kids voices (very lightweight)
    s = s.replace(/ã˜ã‚…ã†ã±ã¡/g,"ã˜ã‚…ã†ã¯ã¡");
    s = s.replace(/ã˜ã‚…ã¯ã¡/g,"ã˜ã‚…ã†ã¯ã¡");
    s = s.replace(/ã«ã˜ã‚…ã—/g,"ã«ã˜ã‚…ã†ã—");
    s = s.replace(/ã•ã‚“ã˜ã‚…ã«/g,"ã•ã‚“ã˜ã‚…ã†ã«");
    s = s.replace(/ã—ã˜ã‚…ã«/g,"ã—ã˜ã‚…ã†ã«");
    s = s.replace(/ã—ã¡ã˜ã‚…ã«/g,"ã—ã¡ã˜ã‚…ã†ã«");
    return s;
  }
  function parseAnswer(text){
    const raw0 = normalize(text);
    if (!raw0) return null;

    // If it's Kanji numerals (e.g., åå…«), parse first
    const kan = parseKanjiNumber(raw0);
    if (kan != null) return kan;

    // Allow "18" etc
    const m = raw0.match(/\d{1,2}/);
    if (m){ const n = Number(m[0]); if (Number.isFinite(n)) return n; }

    const raw = raw0; // keep name used below

    if (raw in ALIAS) return ALIAS[raw];
    if (raw in WORD) return WORD[raw];

    // Contains-match (last resort)
    for (const k of Object.keys(WORD).sort((a,b)=>b.length-a.length)){
      if (k.length>=2 && raw.includes(k)) return WORD[k];
    }
    return null;
  }
  function pickBestAnswer(alts){
    for (const t of alts){
      const n = parseAnswer(t);
      if (n != null) return n;
    }
    return null;
  }

  function shuffle(arr){
    for (let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]] = [arr[j],arr[i]];
    }
    return arr;
  }
  function buildPool(){
    if (selectedCourse === "random"){
      return shuffle([...KUKU]).slice(0, selectedCount);
    }
    const dans = [...selectedDans].sort((a,b)=>a-b);
    if (selectedCourse === "down") dans.reverse();
    let items = [];
    for (const a of dans){
      const row = KUKU.filter(x => x.a === a).sort((x,y)=>x.b-y.b);
      items.push(...row);
    }
    if (starOn) items = shuffle(items);
    return items;
  }

  function setPlayStopIcon(){
    playStopBtn.innerHTML = paused
      ? '<svg width="26" height="26" viewBox="0 0 24 24"><path d="M9 6v12l10-6-10-6Z" fill="white"/></svg>'
      : '<svg width="26" height="26" viewBox="0 0 24 24"><path d="M7 7h4v10H7V7Zm6 0h4v10h-4V7Z" fill="white"/></svg>';
  }
  setPlayStopIcon();

  function startQuestionTimer(){
    stopTimers();
    tStart = performance.now();
    setTicks(5);

    let secLeft = 5;
    tickInterval = setInterval(()=>{
      if (!running || paused || locked){ stopTimers(); return; }
      secLeft -= 1;
      if (secLeft >= 0){
        beep({freq: 950, dur: 0.045, vol: 0.03, type:"sine"});
        setTicks(secLeft);
      }
    }, 1000);

    tickTimer = setTimeout(()=>{
      if (!running || paused || locked) return;
      ng += 1; updateScore();
      buzz();
      nextQuestion();
    }, LIMIT_MS);
  }

  async function nextQuestion(){
    stopTimers();
    window.speechSynthesis && window.speechSynthesis.cancel();

    if (!running || paused) return;

    if (idx >= pool.length){
      finishGame();
      return;
    }

    current = pool[idx++];
    qMath.textContent = `${current.a} Ã— ${current.b}`;
    qYomi.textContent = current.yomi;
    if (srLast) srLast.innerHTML = 'ãã“ãˆãŸ: <b>-</b>';

    locked = true;
    await speakAsync(`${current.yomi}ã€‚`);
    locked = false;
    if (!running || paused) return;

    startQuestionTimer();
  }

  function handleAnswer(n){
    if (!running || paused || locked) return;
    locked = true;
    stopTimers();
    window.speechSynthesis && window.speechSynthesis.cancel();

    const correct = current && (n === current.answer);
    if (correct){
      ok += 1; updateScore();
      pingpong();
      bubbleGame.textContent = "ã„ã„ã­ï¼";
    }else{
      ng += 1; updateScore();
      buzz();
      bubbleGame.textContent = "ãŠã—ã„ï¼";
    }
    setTimeout(()=>{ locked = false; if (running && !paused) nextQuestion(); }, 220);
  }

  function finishGame(){
    stopTimers();
    window.speechSynthesis && window.speechSynthesis.cancel();

    running = false;
    paused = true;
    locked = false;
    setPlayStopIcon();

    // stop SR (but keep mic meter)
    recActive = false;
    if (restartTimer) clearTimeout(restartTimer);
    safeAbortRec();
    setSRState("idle");

    const total = ok + ng;
    resTotal.textContent = String(total);
    resOk.textContent = String(ok);
    resNg.textContent = String(ng);

    applauseAndCheer();
    setScreen("result");
  }

  async function startGame(){
    ensureAudio();

    // Avoid mic contention: SR and getUserMedia can't reliably share the mic on Android.
    if (hasSR){
      stopMicMeter(); // release mic if it was open
    } else {
      const okMic = await ensureMic();
      if (okMic) startMicMeterLoop();
    }

    ok = 0; ng = 0; updateScore();
    pool = buildPool();
    idx = 0;
    running = true;
    paused = false;
    locked = false;
    setPlayStopIcon();
    setScreen("game");
    bubbleGame.textContent = "ã„ãã‚ˆï¼";

    // SR must be started inside a user gesture -> this function is called by click handlers only.
    if (hasSR) {
      await primeSRInGesture();
      setTimeout(()=>{ if (recActive && !recRunning) scheduleRestart(); }, 350);
    }

    nextQuestion();
  }

  function stopGameStay(){
    running = false;
    paused = true;
    locked = false;
    stopTimers();
    window.speechSynthesis && window.speechSynthesis.cancel();
    setPlayStopIcon();
    bubbleGame.textContent = "ã¨ã‚ãŸã‚ˆ";

    // stop SR
    recActive = false;
    if (restartTimer) clearTimeout(restartTimer);
    safeAbortRec();
    setSRState("idle");

    // show mic meter while stopped (no SR running)
    (async ()=>{
      const okMic = await ensureMic();
      if (okMic) startMicMeterLoop();
    })();
  }

  async function resumeGame(){
    ensureAudio();

    if (hasSR){
      stopMicMeter(); // free mic for SR
    } else {
      const okMic = await ensureMic();
      if (okMic) startMicMeterLoop();
    }

    running = true;
    paused = false;
    locked = false;
    setPlayStopIcon();
    bubbleGame.textContent = "ã•ã„ã‹ã„ï¼";

    if (hasSR) {
      await primeSRInGesture();
      setTimeout(()=>{ if (recActive && !recRunning) scheduleRestart(); }, 350);
    }

    if (!current || idx===0) {
      nextQuestion();
    } else {
      (async ()=>{
        locked = true;
        await speakAsync(`${current.yomi}ã€‚`);
        locked = false;
        if (running && !paused) startQuestionTimer();
      })();
    }
  }

  // UI: course buttons
  courseUpBtn.addEventListener("click", ()=>{
    ensureAudio();
    selectedCourse = "up";
    selectedDans = new Set([1]);
    starOn = false;
    buildDanTiles();
    const t1 = danTiles.querySelector('.tile[data-dan="1"]');
    if (t1) t1.classList.add("on");
    setScreen("dan");
  });

  courseDownBtn.addEventListener("click", ()=>{
    ensureAudio();
    selectedCourse = "down";
    selectedDans = new Set([9]);
    starOn = false;
    buildDanTiles();
    const t9 = danTiles.querySelector('.tile[data-dan="9"]');
    if (t9) t9.classList.add("on");
    setScreen("dan");
  });

  courseRandomBtn.addEventListener("click", ()=>{
    ensureAudio();
    selectedCourse = "random";
    selectedCount = 10;
    buildCountTiles();
    setScreen("count");
  });

  backCourse1.addEventListener("click", ()=>{ ensureAudio(); setScreen("course"); });
  backCourse2.addEventListener("click", ()=>{ ensureAudio(); setScreen("course"); });

  startFromDan.addEventListener("click", ()=>{ ensureAudio(); if (selectedDans.size===0) selectedDans = new Set([1]); startGame(); });
  startFromCount.addEventListener("click", ()=>{ ensureAudio(); startGame(); });

  playStopBtn.addEventListener("click", ()=>{
    ensureAudio();
    if (paused) resumeGame();
    else stopGameStay();
  });

  btnRetry.addEventListener("click", ()=>{ ensureAudio(); setScreen("game"); startGame(); });
  btnEnd.addEventListener("click", ()=>{ ensureAudio(); current=null; pool=[]; idx=0; ok=0; ng=0; updateScore(); setScreen("course"); });

  // initial mic/SR indicator
  if (!hasSR){
    micTxt.textContent = "ğŸ¤ Ã— (SRãªã—)";
    micDot.className = "micDot off";
  } else {
    micTxt.textContent = "ğŸ¤ ã˜ã‚…ã‚“ã³";
    micDot.className = "micDot wait";
  }
})();
</script>
</body>
</html>
